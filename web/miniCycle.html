<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<!-- ‚úÖ Use a solid representative color that matches your theme -->
<meta name="theme-color" content="#5680ff" id="theme-color-meta">

<!-- ‚úÖ Dynamic status bar style -->
<meta name="apple-mobile-web-app-status-bar-style" content="default" id="status-bar-style-meta">

<!-- Add cache prevention for development -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="app-version" content="1.355">

<title>miniCycle - Turn Your Routine Into Progress</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<!-- Add cache busting version parameter -->
<link rel="stylesheet" href="miniCycle-styles.css?v=1.355">
<link rel="manifest" href="manifest.json">



<style>
  /* Notification styles */
  #notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 300px;
    cursor: move;
  }
  #notification-container.dragging {
    opacity: 0.8;
    cursor: grabbing;
  }
  .notification {
    background-color: #333;
    color: #fff;
    padding: 12px 16px;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    position: relative;
    overflow-wrap: anywhere;
  }
  .notification.show {
    opacity: 1;
    transform: translateY(0);
  }
  .notification.error { background-color: #e74c3c; }
  .notification.success { background-color: #27ae60; }
  .notification.info { background-color: #2980b9; }
  .notification.warning { background-color: #f39c12; }
  .notification.recurring { background-color: #8e44ad; }  

  .notification .notification-content {
    margin-right: 24px; /* Space for close button */
  }

  /* Footer mobile layout is defined in miniCycle-styles.css */

  </style>




<script src="./version.js"></script>

<script>

// Minimal, ES3-safe feature gate: if arrow functions can't be parsed, go Lite.
(function () {
  var needsLite = false;
  var reasons = [];

  try { new Function('()=>{}'); } catch (e) { needsLite = true; reasons.push('no-arrow-fn'); }

  if (!needsLite) {
    var w = window;
    if (!w.Promise) { needsLite = true; reasons.push('no-promise'); }
    if (!w.fetch)   { needsLite = true; reasons.push('no-fetch'); }
    try {
      localStorage.setItem('__t','1'); localStorage.removeItem('__t');
    } catch (e) {
      window.__LocalStorageBlocked = true;
      reasons.push('localStorage-blocked'); // not fatal
    }
  }

  var forcedFull = (location.search.indexOf('mode=full') !== -1);
  try { forcedFull = forcedFull || localStorage.getItem('miniCycleForceFullVersion') === 'true'; } catch(e){}

  window.__FeatureGateNeedsLite = needsLite;
  window.__FeatureGateReasons = reasons;

  if (needsLite && !forcedFull && location.pathname.indexOf('miniCycle-lite.html') === -1) {
    location.replace('./lite/miniCycle-lite.html?mode=lite&src=feature-gate&reasons=' + encodeURIComponent(reasons.join(',')));
  }
})();

// ‚úÖ Enhanced Service Worker Registration with Update Management
if ('serviceWorker' in navigator) {
  let refreshing;

  // ‚úÖ SW version - increment this when you update the service worker
  const SW_VERSION = '1338';
  const CURRENT_CACHE_VERSION = 'v115'; // Must match service-worker.js

  // ‚úÖ Function to register service worker with all event listeners
  async function registerServiceWorker() {
    const registration = await navigator.serviceWorker.register(`./service-worker.js?v=1.355${SW_VERSION}`, {
      updateViaCache: 'none'
    });
    console.log('‚úÖ Service Worker registered successfully:', registration.scope);

    // Handle service worker updates
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      console.log('üîÑ New service worker installing...');

      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed') {
          if (navigator.serviceWorker.controller) {
            console.log('üÜï New app version available!');
            showUpdateAvailable(registration);
          } else {
            console.log('üì± App cached for offline use');
            showAppCachedNotification();
          }
        }
      });
    });

    // Handle controlled page refresh - AUTO-RELOAD when new SW takes control
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return;
      refreshing = true;
      console.log('üîÑ New service worker is now controlling the page - reloading...');
      window.location.reload();
    });

    // Force check for updates when page becomes visible
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && registration) {
        console.log('üëÅÔ∏è Page visible again - checking for updates...');
        registration.update().catch(err => {
          console.warn('Update check failed:', err);
        });
      }
    });

    // Check for updates every 60 seconds
    setInterval(() => {
      if (!document.hidden && registration) {
        console.log('‚è∞ Periodic update check...');
        registration.update().catch(err => {
          console.warn('Periodic update check failed:', err);
        });
      }
    }, 60000);
  }

  window.addEventListener('load', async () => {
    try {
      // ‚úÖ CHECK FLAG FIRST - Skip migration if already done
      if (localStorage.getItem('sw-migration-v1327-done') === 'true') {
        console.log('‚úÖ Migration already completed - skipping old SW checks');
        // Jump straight to registration
        await registerServiceWorker();
        return;
      }

      // ‚úÖ STEP 0: NUCLEAR OPTION - Clear old caches BEFORE checking SW
      // This ensures old cached files don't persist
      const allCaches = await caches.keys();
      const oldCaches = allCaches.filter(name =>
        name.includes('miniCycle-') &&
        !name.includes(CURRENT_CACHE_VERSION) // Keep only current version caches
      );

      if (oldCaches.length > 0) {
        console.log(`üßπ Found ${oldCaches.length} old cache(s), deleting...`);
        for (const cacheName of oldCaches) {
          await caches.delete(cacheName);
          console.log(`‚úÖ Deleted old cache: ${cacheName}`);
        }
      }

      // ‚úÖ STEP 1: Check for old service worker registrations and clean them up
      const existingRegistrations = await navigator.serviceWorker.getRegistrations();
      console.log(`üîç Found ${existingRegistrations.length} existing service worker(s)`);

      let needsReload = false;

      // Check if we have an old SW without version parameter
      for (const reg of existingRegistrations) {
        const scriptURL = reg.active?.scriptURL || reg.waiting?.scriptURL || reg.installing?.scriptURL;
        if (scriptURL && scriptURL.includes('service-worker.js') && !scriptURL.includes('?v=1.355')) {
          console.log('üóëÔ∏è Found old service worker without version - unregistering:', scriptURL);
          await reg.unregister();
          console.log('‚úÖ Old service worker unregistered successfully');
          needsReload = true;
        }
      }

      // ‚úÖ If we unregistered an old SW, prompt user to reload once
      if (needsReload) {
        console.log('üîÑ Old service worker removed - prompting user to reload');

        // Set flag IMMEDIATELY (use localStorage for persistence across sessions)
        localStorage.setItem('sw-migration-v1327-done', 'true');

        // Show user-friendly notification
        setTimeout(() => {
          if (typeof showNotification === 'function') {
            showNotification('üîÑ App update ready - reload recommended', 'info', 8000);
          }

          if (typeof showConfirmationModal === 'function') {
            showConfirmationModal({
              title: "üîÑ Important App Update",
              message: `We've updated miniCycle's core system!<br><br>
                       ‚úÖ Old version has been safely removed<br>
                       üÜï New version is ready to install<br>
                       üîÑ Please reload the page to complete the update<br><br>
                       This is a one-time update to improve future update reliability.`,
              confirmText: "üîÑ Reload Now",
              cancelText: "Later",
              callback: (confirmed) => {
                if (confirmed) {
                  window.location.reload();
                }
              }
            });
          } else {
            // Fallback
            if (confirm('üîÑ App update ready!\n\nReload now to complete the update?\n(One-time update to improve future updates)')) {
              window.location.reload();
            }
          }
        }, 1500);
        return; // Don't register SW yet - wait for reload
      }

      // ‚úÖ STEP 2: Register new service worker (no old SW found, or migration complete)
      await registerServiceWorker();

    } catch (error) {
      console.error('‚ùå Service Worker registration failed:', error);
    }
  });
  
  // ‚úÖ Function to show update notification using your confirmation modal
  function showUpdateAvailable(registration) {
    // First show a notification
    if (typeof showNotification === 'function') {
      showNotification('üÜï New app version available!', 'info', 5000);
    }
    
    // Then show confirmation modal after a brief delay
    setTimeout(() => {
      if (typeof showConfirmationModal === 'function') {
        showConfirmationModal({
          title: "üöÄ App Update Available!",
          message: `A new version of miniCycle is ready to install!<br><br>
                   ‚ú® New features and improvements<br>
                   üêõ Bug fixes and performance enhancements<br>
                   üîí Latest security updates<br><br>
                   <strong>Don't worry:</strong> After clicking "Prepare Update", you'll be asked again before the page reloads. Your work is safe!`,
          confirmText: "‚úÖ Prepare Update",
          cancelText: "Maybe Later",
          callback: (confirmed) => {
            if (confirmed) {
              updateServiceWorker(registration);
              showNotification('‚è≥ Preparing update in background...', 'info', 3000);
            } else {
              showNotification('‚ÑπÔ∏è Update postponed - you can install it anytime from Settings', 'info', 6000);
            }
          }
        });
      } else {
        // Fallback to browser confirm if modal isn't available yet
        if (confirm('üÜï New app version available! Would you like to update now?')) {
          updateServiceWorker(registration);
        }
      }
    }, 1000);
  }
  
  // ‚úÖ Function to show app cached notification
  function showAppCachedNotification() {
    if (typeof showNotification === 'function') {
      showNotification('üì± miniCycle is now available offline!', 'success', 4000);
    }
  }
  
  // ‚úÖ Function to update service worker
  function updateServiceWorker(registration) {
    if (!registration.waiting) return;

    // Tell the waiting service worker to take control
    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
  }

  // ‚úÖ Function to ask user if they want to reload NOW or LATER
  function showReloadConfirmation() {
    console.log('üì¢ Asking user if they want to reload now...');

    // Show notification first
    if (typeof showNotification === 'function') {
      showNotification('‚úÖ Update installed! Ready to reload?', 'success', 5000);
    }

    // Then show confirmation modal
    setTimeout(() => {
      if (typeof showConfirmationModal === 'function') {
        showConfirmationModal({
          title: "‚úÖ Update Installed Successfully!",
          message: `The app has been updated in the background.<br><br>
                   üîÑ <strong>Reload now</strong> to start using the new version<br>
                   ‚è∞ <strong>Or reload later</strong> when you're ready<br><br>
                   Your tasks and data are safe - nothing will be lost. The update will apply on your next visit if you choose to wait.`,
          confirmText: "üîÑ Reload Now",
          cancelText: "‚è∞ Reload Later",
          callback: (confirmed) => {
            if (confirmed) {
              console.log('User confirmed reload - reloading now...');
              if (typeof showNotification === 'function') {
                showNotification('üîÑ Reloading to apply update...', 'info', 2000);
              }
              setTimeout(() => {
                window.location.reload();
              }, 500);
            } else {
              console.log('User postponed reload - will apply on next page load');
              if (typeof showNotification === 'function') {
                showNotification('‚úÖ Update will apply on your next visit', 'info', 4000);
              }
            }
          }
        });
      } else {
        // Fallback to browser confirm if modal isn't available yet
        const reloadNow = confirm('‚úÖ Update installed!\n\nReload now to apply the update?\n\n(You can also reload later - the update is ready and waiting)');
        if (reloadNow) {
          window.location.reload();
        } else {
          console.log('User chose to reload later');
        }
      }
    }, 1000);
  }
  
} else {
  console.warn('‚ö†Ô∏è Service Workers not supported in this browser');
}

// ‚úÖ Expose update function globally for manual updates
window.checkForUpdates = async function() {
  if (!('serviceWorker' in navigator)) {
    console.warn('Service Workers not supported');
    if (typeof showNotification === 'function') {
      showNotification('‚ùå Service Workers not supported', 'error', 3000);
    }
    return;
  }
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    if (!registration) {
      if (typeof showNotification === 'function') {
        showNotification('‚ùå No service worker registered', 'error', 3000);
      }
      return;
    }

    // Get current version info
    const currentVersion = await getServiceWorkerVersion(registration);
    
    if (typeof showNotification === 'function') {
      showNotification('üîç Checking for app updates...', 'info', 2000);
    }
    
    // Force check for updates
    await registration.update();
    
    // Wait a moment for the update check to process
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Check if there's a waiting worker (new version available)
    if (registration.waiting) {
      // Get new version info from the waiting worker
      const newVersion = await getWaitingWorkerVersion(registration.waiting);
      
      // Show detailed update modal
      if (typeof showConfirmationModal === 'function') {
        showConfirmationModal({
          title: "üÜï Update Available!",
          message: `A new version of miniCycle is available!<br><br>
                   <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px; margin: 8px 0;">
                   ÔøΩ <strong>Current Version:</strong> ${currentVersion}<br>
                   üöÄ <strong>New Version:</strong> ${newVersion}<br>
                   </div>
                   ‚ú® This update includes new features and improvements<br>
                   üêõ Bug fixes and performance enhancements<br>
                   üîí Latest security updates<br><br>
                   You can choose to update now or continue using the current version. The update is optional and you can install it whenever you're ready.`,
          confirmText: "üîÑ Update Now",
          cancelText: "Later",
          callback: (confirmed) => {
            if (confirmed) {
              updateServiceWorker(registration);
              if (typeof showNotification === 'function') {
                showNotification('üîÑ Installing update...', 'info', 3000);
              }
            } else {
              if (typeof showNotification === 'function') {
                showNotification('‚ÑπÔ∏è Update postponed - you can install it anytime', 'info', 4000);
              }
            }
          }
        });
      } else {
        // Fallback to browser confirm if modal isn't available yet
        const updateConfirmed = confirm(`üÜï Update Available!\n\nCurrent: ${currentVersion}\nNew: ${newVersion}\n\nWould you like to update now?`);
        if (updateConfirmed) {
          updateServiceWorker(registration);
        }
      }
    } else if (registration.installing) {
      // Update is currently installing
      if (typeof showNotification === 'function') {
        showNotification('‚è≥ Update is currently installing...', 'info', 3000);
      }
    } else {
      // No update available
      if (typeof showNotification === 'function') {
        showNotification(`‚úÖ App is up to date! (${currentVersion})`, 'success', 3000);
      }
    }
    
  } catch (error) {
    console.error('Failed to check for updates:', error);
    if (typeof showNotification === 'function') {
      showNotification('‚ùå Failed to check for updates', 'error', 3000);
    }
  }
};

// ‚úÖ Add service worker info to your testing modal
window.getServiceWorkerInfo = async function() {
  if (!('serviceWorker' in navigator)) {
    return { supported: false };
  }
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    
    return {
      supported: true,
      registered: !!registration,
      scope: registration?.scope || 'Not registered',
      state: registration?.active?.state || 'Unknown',
      updateAvailable: !!registration?.waiting,
      scriptURL: registration?.active?.scriptURL || 'Not available',
      version: await getServiceWorkerVersion(registration)
    };
  } catch (error) {
    return {
      supported: true,
      registered: false,
      error: error.message
    };
  }
};

// ‚úÖ Helper function to get SW version
async function getServiceWorkerVersion(registration) {
  if (!registration || !registration.active) return 'Unknown';
  
  return new Promise((resolve) => {
    const messageChannel = new MessageChannel();
    messageChannel.port1.onmessage = (event) => {
      // Enhanced version info with both cache and app version
      const versionData = event.data;
      if (versionData && versionData.version && versionData.appVersion) {
        resolve(`SW: ${versionData.version}, App: ${versionData.appVersion}`);
      } else {
        resolve(event.data?.version || 'Unknown');
      }
    };
    
    registration.active.postMessage({ type: 'GET_VERSION' }, [messageChannel.port2]);
    
    // Timeout after 2 seconds
    setTimeout(() => resolve('Timeout'), 2000);
  });
}

// ‚úÖ Helper function to get version from waiting worker
async function getWaitingWorkerVersion(waitingWorker) {
  if (!waitingWorker) return 'Unknown';
  
  return new Promise((resolve) => {
    const messageChannel = new MessageChannel();
    messageChannel.port1.onmessage = (event) => {
      // Enhanced version info with both cache and app version
      const versionData = event.data;
      if (versionData && versionData.version && versionData.appVersion) {
        resolve(`SW: ${versionData.version}, App: ${versionData.appVersion}`);
      } else {
        resolve(event.data?.version || 'Unknown');
      }
    };
    
    waitingWorker.postMessage({ type: 'GET_VERSION' }, [messageChannel.port2]);
    
    // Timeout after 2 seconds
    setTimeout(() => resolve('Unknown (New)'), 2000);
  });
}

// ‚úÖ Add manual update check to your testing modal
window.forceServiceWorkerUpdate = async function() {
  if (!('serviceWorker' in navigator)) {
    if (typeof showNotification === 'function') {
      showNotification('‚ùå Service Workers not supported', 'error', 3000);
    }
    return;
  }
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    if (registration) {
      // Get current version before forcing update
      const currentVersion = await getServiceWorkerVersion(registration);
      
      if (typeof showNotification === 'function') {
        showNotification('üîÑ Force checking for updates...', 'info', 2000);
      }
      
      await registration.update();
      
      // Wait a moment for the update check to process
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Check if there's a waiting worker
      if (registration.waiting) {
        const newVersion = await getWaitingWorkerVersion(registration.waiting);
        
        if (typeof showConfirmationModal === 'function') {
          showConfirmationModal({
            title: "üîÑ Update Ready!",
            message: `An update is ready to install!<br><br>
                     <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px; margin: 8px 0;">
                     üìä <strong>Current Version:</strong> ${currentVersion}<br>
                     üöÄ <strong>New Version:</strong> ${newVersion}<br>
                     </div>
                     Would you like to apply it now?`,
            confirmText: "Apply Update",
            cancelText: "Cancel",
            callback: (confirmed) => {
              if (confirmed) {
                updateServiceWorker(registration);
                if (typeof showNotification === 'function') {
                  showNotification('üîÑ Installing update...', 'info', 3000);
                }
              }
            }
          });
        } else {
          // Fallback to browser confirm
          const updateConfirmed = confirm(`üîÑ Update Ready!\n\nCurrent: ${currentVersion}\nNew: ${newVersion}\n\nApply update now?`);
          if (updateConfirmed) {
            updateServiceWorker(registration);
          }
        }
      } else {
        if (typeof showNotification === 'function') {
          showNotification(`‚úÖ App is up to date! (${currentVersion})`, 'success', 2000);
        }
      }
    } else {
      if (typeof showNotification === 'function') {
        showNotification('‚ùå No service worker registered', 'error', 2000);
      }
    }
  } catch (error) {
    console.error('Failed to force update:', error);
    if (typeof showNotification === 'function') {
      showNotification('‚ùå Failed to check for updates', 'error', 3000);
    }
  }
};

// ‚úÖ ADD: Handle PWA shortcuts (add after service worker registration)
window.addEventListener('DOMContentLoaded', () => {
  const fragment = window.location.hash;
  
  if (fragment === '#add-task') {
    setTimeout(() => {
      const taskInput = document.getElementById('taskInput');
      if (taskInput) {
        taskInput.focus();
        taskInput.scrollIntoView({ behavior: 'smooth' });
      }
    }, 500);
    // Clear the fragment
    history.replaceState(null, '', './miniCycle.html');
  } 
  else if (fragment === '#stats') {
    setTimeout(() => {
      // Show stats panel if function exists
      if (typeof showStatsPanel === 'function') {
        showStatsPanel();
      }
    }, 500);
    // Clear the fragment
    history.replaceState(null, '', './miniCycle.html');
  }
});


// ‚úÖ ADD: PWA Install Prompt
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üì± Install prompt available');
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install suggestion for new users
  setTimeout(() => {
    if (typeof showNotification === 'function') {
      showNotification(
        'üì± Install miniCycle for offline access and faster loading!', 
        'info', 
        6000
      );
    }
  }, 45000); // After 45 seconds for full version
});

// Global install function
window.installApp = () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('üì± User accepted the install prompt');
        if (typeof showNotification === 'function') {
          showNotification('üéâ miniCycle installed successfully!', 'success', 4000);
        }
      }
      deferredPrompt = null;
    });
  }
};

</script>






</head>

<body>
  <!-- Initial App Loader -->
  <div id="app-loader">
    <img src="assets/images/logo/minicycle_logo_icon.png" alt="Loading..." class="loader-logo">
    <div class="loader-text">Loading miniCycle...</div>
  </div>

  <!-- Loading Overlay for Operations -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner">
      <img src="assets/images/logo/minicycle_logo_icon.png" alt="Loading...">
      <div class="loading-spinner-text">Processing...</div>
    </div>
  </div>

  <div id="notification-container" aria-live="polite"></div> <!-- Notification container --> 


  

<header class="mini-cycle-header-row">
  <!-- Mode Selector -->
  <div class="mode-selector-container">
    <select id="mode-selector" class="mode-selector" aria-label="Select mode" title="Switch mode: Auto Cycle, Manual Cycle, or To-Do">
      <option value="auto-cycle" title="Automatically cycle tasks">Auto Cycle ‚Üª</option>
      <option value="manual-cycle" title="Manually cycle through tasks">Manual Cycle ‚úîÔ∏é‚Üª</option>
      <option value="todo-mode" title="Simple To-Do list mode">To-Do Mode ‚úì</option>
    </select>
  </div>

  <!-- Logo and App Name -->
  <div class="header-branding">
    <img src="assets/images/logo/logo.png" alt="miniCycle" class="header-logo">
    <img src="assets/images/logo/app_name.png" alt="miniCycle App Name" class="app-name">
  </div>

  <!-- Menu Button -->
  <button class="menu-button" aria-label="Menu" title="Open menu">‚ò∞</button>
</header>

<!-- Mobile Mode Selector (below header) -->
<div class="mobile-mode-selector-wrapper">
  <select id="mobile-mode-selector" class="mode-selector" aria-label="Select mode (mobile)" title="Switch mode (mobile): Auto Cycle, Manual Cycle, or To-Do">
    <option value="auto-cycle" title="Automatically cycle tasks">Auto Cycle ‚Üª ‚ñº</option>
    <option value="manual-cycle" title="Manually cycle through tasks">Manual Cycle ‚úîÔ∏é‚Üª ‚ñº</option>
    <option value="todo-mode" title="Simple To-Do list mode">To-Do Mode ‚úì ‚ñº</option>
  </select>
</div>


    <!-- Main Menu -->
    <nav class="menu-container" data-modal data-menu>
        <div id="main-menu-header-row" class="main-menu-header-row">
            <div class="main-menu-header-logo">
                <img src="assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" alt="Task Cycle Logo" />
            </div> 
            <div id="main-menu-header" class="main-menu-header">
                <span id="main-menu-mini-cycle-title"></span>  <!-- miniCycle Title -->
                <span id="current-date"></span>  <!-- Date will be inserted here -->
            </div>
             <!-- About Section Trigger -->
      <button id="open-about-modal" class="open-about-modal" aria-label="About Task Cycle Mini" title="About miniCycle">
        <i class="fas fa-info-circle" aria-hidden="true"></i>
        </button>


                
        </div>

       

            <!-- About Modal -->
            <div id="about-modal" class="modal" data-modal role="dialog" aria-modal="true" aria-labelledby="about-modal-title">
                <div class="modal-content">
                    <span class="close-modal" role="button" tabindex="0" aria-label="Close about modal">&times;</span>
                  <h2 id="about-modal-title">About miniCycle</h2>
                    <p><strong>Version:</strong> <span id="about-version">‚Äî</span></p>
                    <p><strong>Service Worker Cache:</strong> <span id="about-sw-version">‚Äî</span></p>
          <p>miniCycle is your routine workflow companion ‚Äî turn repeatable tasks into effortless cycles, stay focused, and build momentum.</p>
          <p>Developed by <strong>sparkinCreations</strong>.</p>
          <p><a href="pages/product.html" target="_blank" rel="noopener noreferrer">Learn more about miniCycle</a></p>
          <p>Visit <a href="https://sparkincreations.com" target="_blank" rel="noopener noreferrer">our website</a> for updates!</p>
          <p class="about-legal" style="font-size: 12px; opacity: 0.8; margin-top: 8px;">&copy; 2025 sparkinCreations &bull; miniCycle&trade;</p>
                </div>
            </div>


            <!--Main Menu-->
        <div class="menu-buttons-together">
        <ul>
            <div class="main-menu-row">
            <li><button id="new-mini-cycle" title="Create a new routine"><i class="fas fa-plus"></i>New <br>Routine</button></li>
            <li><button id="open-mini-cycle" title="Open an existing routine"><i class="fas fa-folder-open"></i>Open Existing<br>Routine</button></li>
            <li><button id="save-as-mini-cycle" title="Duplicate the current routine"><i class="fas fa-copy"></i>Duplicate <br>Routine</button></li>
            </div>
            <div class="main-menu-row">
            <li><button id="export-mini-cycle" title="Download the current routine as a file"><i class="fas fa-file-download"></i>Download <br>Routine</button></li>
            <li><button id="import-mini-cycle" title="Import a routine from a file"><i class="fas fa-file-upload"></i> Import <br>Routine</button></li>
          <div class="divider-vertical"></div>
            <li><button id="clear-mini-cycle-tasks" title="Uncheck all tasks in this routine"><i class="fas fa-eraser"></i> Uncheck All<br>Tasks</button></li>
            <li><button id="delete-all-mini-cycle-tasks" title="Delete all tasks in this routine"><i class="fas fa-trash"></i> Delete All<br>Tasks</button></li>
            </div>
            <div class="main-menu-row">
                <li><button id="open-reminders-modal" title="Configure reminders and notifications"><i class="fas fa-bell"></i>Reminders &<br> Notifications</button></li>
                <li><button id="open-feedback-modal" class="open-feedback-modal"><i class="fas fa-comment"></i>Send <br> Feedback</button></li>
                <li><button id="open-user-manual" class="open-user-manual" title="Open the user manual"><i class="fas fa-book"></i>User Manual</button></li>
                <li><button id="open-settings" class="open-settings" title="Open settings"><i class="fas fa-cog"></i>Settings</button></li>
                </div>
           </ul>
        </div>



    <!-- Theme Button: ONLY SHOWN if theme is unlocked -->
<div class="unlockables">
    <div id="themes-menu-option" class="themes-menu-option">
        <div id="open-themes-panel" class="open-themes-panel" role="button" tabindex="0" aria-label="Open Themes Panel">
            <i class="fas fa-palette" aria-hidden="true"></i> Themes
          </div>          
    </div>
  
    <div id="games-menu-option" style="display: none;">
      <div id="open-games-panel">
        <i class="fas fa-gamepad"></i> Games
      </div>
    </div>
  </div>

        <div class="main-menu-controls-container">
            <div id="mode-description" class="mode-description" aria-live="polite"></div>
           <div class="toggle-container" id="autoResetContainer" style="display: none;">
            <label class="switch">
                <input type="checkbox" id="toggleAutoReset" aria-label="Toggle auto reset" checked>
                <span class="slider round"></span>
              </label>              
            <span class="label-text">Auto Reset</span>
        </div>
        
        <div class="checkbox-container" id="deleteCheckedTasksContainer" style="display: none;">
            <label class="custom-checkbox" for="deleteCheckedTasks">
              <input 
                type="checkbox" 
                id="deleteCheckedTasks" 
                aria-labelledby="delete-label"
              />
              <span class="checkmark" aria-hidden="true"></span>
              <span id="delete-label">Delete Checked Tasks after Complete</span>
            </label>
          </div>  
    </div>



 
  
  <button id="open-recurring-panel" class="open-recurring-panel hidden" title="Manage recurring tasks"><i class="fas fa-repeat"></i> Manage Recurring Tasks</button>
    

    
  
    <button id="close-main-menu" aria-label="Close Main Menu">Close</button>
    <!--<button id="exit-mini-cycle"><i class="fas fa-sign-out-alt"></i> Exit to Main Menu </button>-->
        
</nav>



<!-- Recurring Panel Modal w/ Overlay -->
<div id="recurring-panel-overlay" class="modal-overlay hidden" role="dialog" aria-labelledby="recurring-panel-title" aria-modal="true">
  <div id="recurring-panel" class="modal-panel">
    <h3 id="recurring-panel-title">Recurring Tasks</h3>
    <div id="recurring-toggle-actions" class="hidden">
      <button id="toggle-check-all" class="toggle-check-btn">Check All</button>
    </div>
    <div class="recurring-scroll-area">
      <ul id="recurring-task-list" aria-label="List of recurring tasks"></ul>
    </div>
    <div id="recurring-summary-preview" class="hidden">
      <div class="summary-box">
        <p id="recurring-preview-text"></p>
        <button id="change-recurring-settings" class="change-recurring-btn">Change Recurring Settings</button>
      </div>
    </div>
    <div id="recurring-settings-panel" class="hidden" aria-live="polite">
      <label for="recur-specific-dates">
        <input type="checkbox" id="recur-specific-dates" aria-describedby="specific-dates-desc">
        Specific date(s)
      </label>
      <div id="specific-dates-desc" class="visually-hidden">
        Allows you to pick specific calendar dates for the task to recur.
      </div>
      
      <div id="specific-dates-panel" class="hidden">
        <div id="specific-date-list">
          <!-- First date picker inserted by JS -->
        </div>
        <button id="add-specific-date" type="button"><span class="plus-icon">+</span> Add Another Date</button>
      </div>
      
      <div id="specific-date-time-options" class="hidden">
        <label>
          <input type="checkbox" id="specific-date-specific-time">
          Choose specific time
        </label>
      
        <div id="specific-date-time-container" class="hidden">
          <div class="time-picker-wrapper">
            <div class="time-picker-stack">
              <div class="time-picker-group">
                <label for="specific-date-hour" class="visually-hidden">Hour</label>
                <input type="number" id="specific-date-hour" min="1" max="12" placeholder="Hours"> :
                <label for="specific-date-minute" class="visually-hidden">Minute</label>
                <input type="number" id="specific-date-minute" min="0" max="59" placeholder="Minutes">
      
                <select id="specific-date-meridiem">
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
                </select>
              </div>
      
              <label class="time-format-toggle">
                <input type="checkbox" id="specific-date-military">
                Check box to use 24-hour format
              </label>
            </div>
          </div>
        </div>
      </div>
      <label style="display: flex; align-items: center; margin: 10px 0;">
        <input type="checkbox" id="recur-indefinitely" style="margin-right: 8px;" checked>
        Recur indefinitely
      </label>

      <div id="recur-limited-container" class="hidden" style="margin-left: 24px;">
        <label style="display: block; margin: 6px 0;">
          <input type="radio" name="recur-duration-type" id="recur-count-radio" value="count" checked>
          Specific number of times
        </label>
        <div id="recur-count-container" class="hidden" style="margin-left: 24px;">
          <label for="recur-count-input" style="display: block; margin: 8px 0;">Number of occurrences:</label>
          <input type="number" id="recur-count-input" min="1" value="1" style="width: 80px; padding: 4px;">
        </div>

        <label style="display: block; margin: 6px 0;">
          <input type="radio" name="recur-duration-type" id="recur-until-radio" value="until">
          Until specific date
        </label>
        <div id="recur-until-container" class="hidden" style="margin-left: 24px;">
          <label for="recur-until-date" style="display: block; margin: 8px 0;">End date:</label>
          <input type="date" id="recur-until-date" style="padding: 4px;">
        </div>
      </div>

      <div id="recur-frequency-container">
        <label for="recur-frequency">Repeat:</label>
        <select id="recur-frequency">
          <option value="hourly">Hourly</option>
          <option value="daily" selected>Daily</option>
          <option value="weekly">Weekly</option>
          <option value="biweekly">Biweekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
      <button id="toggle-advanced-settings" type="button" class="toggle-advanced-btn">
        Show Advanced Options
      </button>
      <!-- Dynamic Frequency Options -->
      <div id="frequency-dynamic-options">


        <!-- Hourly options -->
        <div id="hourly-options" class="frequency-options hidden">
          <label><input type="checkbox" id="hourly-specific-time"> Choose specific minute of each hour</label>
          <div id="hourly-minute-container" class="hidden">
            <div class="time-picker-stack">
            <div class="time-picker-wrapper">
            <div class="time-picker-group">
              <label for="hourly-minute" class="visually-hidden">Minute</label>
            <input type="number" id="hourly-minute" min="0" max="59" placeholder = "Minute">
          </div>
          </div>
          </div>
          </div>
        </div>

        <!-- Daily options -->
        <div id="daily-options" class="frequency-options">
          <label><input type="checkbox" id="daily-specific-time"> Choose specific time of day</label>
          <div id="daily-time-container" class="hidden">
            <div class="time-picker-wrapper">
              <div class="time-picker-stack">
            <div class="time-picker-group">
              <label for="daily-hour" class="visually-hidden">Hour</label>
              <input type="number" id="daily-hour" min="1" max="12" placeholder="Hours">
              :
              <label for="daily-minute" class="visually-hidden">Minute</label>
              <input type="number"  id="daily-minute" min="0" max="59" placeholder="Minutes">
              
              <select id="daily-meridiem">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
            <label class="time-format-toggle">
              <input type="checkbox" id="daily-military"> Check box to use 24-hour format
            </label>
            </div>
            </div>
          </div>
        </div>

     <!-- Weekly options -->
<div id="weekly-options" class="frequency-options hidden">
  <label><input type="checkbox" id="weekly-specific-days"> Choose specific day(s) of the week</label>
  <div id="weekly-day-container" class="hidden">
    <p class="section-label">Select days:</p>
    <div class="weekly-days">
      <div class="weekly-day-box" data-day="Sun">Sun</div>
      <div class="weekly-day-box" data-day="Mon">Mon</div>
      <div class="weekly-day-box" data-day="Tue">Tue</div>
      <div class="weekly-day-box" data-day="Wed">Wed</div>
      <div class="weekly-day-box" data-day="Thu">Thu</div>
      <div class="weekly-day-box" data-day="Fri">Fri</div>
      <div class="weekly-day-box" data-day="Sat">Sat</div>
    </div>
  </div>

  <label><input type="checkbox" id="weekly-specific-time"> Choose specific time</label>
  <div id="weekly-time-container" class="hidden">
    <div class="time-picker-wrapper">
      <div class="time-picker-stack">
      <div class="time-picker-group">
        <label for="weekly-hour" class="visually-hidden">Hour</label>
        <input type="number" id="weekly-hour" min="1" max="12" placeholder="Hours">
        :
        <label for="weekly-minute" class="visually-hidden">Minute</label>
        <input type="number" id="weekly-minute" min="0" max="59" placeholder="Minutes">

        <select id="weekly-meridiem">
          <option value="AM">AM</option>
          <option value="PM">PM</option>
        </select>
      </div>
      <label class="time-format-toggle">
        <input type="checkbox" id="weekly-military"> Check box to use 24-hour format
      </label>
    </div>
    </div>
  </div>
</div>

 <!-- Biweekly options -->
 <div id="biweekly-options" class="frequency-options hidden">
  <label><input type="checkbox" id="biweekly-specific-days"> Choose specific day(s) of the week</label>
  <div id="biweekly-day-container" class="hidden">
    <p class="section-label">Week 1:</p>
    <div class="biweekly-days">
      <div class="biweekly-day-box" data-day="Sun" data-week="1">Sun</div>
      <div class="biweekly-day-box" data-day="Mon" data-week="1">Mon</div>
      <div class="biweekly-day-box" data-day="Tue" data-week="1">Tue</div>
      <div class="biweekly-day-box" data-day="Wed" data-week="1">Wed</div>
      <div class="biweekly-day-box" data-day="Thu" data-week="1">Thu</div>
      <div class="biweekly-day-box" data-day="Fri" data-week="1">Fri</div>
      <div class="biweekly-day-box" data-day="Sat" data-week="1">Sat</div>
    </div>

    <p class="section-label" style="margin-top: 16px;">Week 2:</p>
    <div class="biweekly-days">
      <div class="biweekly-day-box" data-day="Sun" data-week="2">Sun</div>
      <div class="biweekly-day-box" data-day="Mon" data-week="2">Mon</div>
      <div class="biweekly-day-box" data-day="Tue" data-week="2">Tue</div>
      <div class="biweekly-day-box" data-day="Wed" data-week="2">Wed</div>
      <div class="biweekly-day-box" data-day="Thu" data-week="2">Thu</div>
      <div class="biweekly-day-box" data-day="Fri" data-week="2">Fri</div>
      <div class="biweekly-day-box" data-day="Sat" data-week="2">Sat</div>
    </div>
  </div>




  <label>
    <input type="checkbox" id="biweekly-specific-time">
    Choose specific time
  </label>

  <div id="biweekly-time-container" class="hidden">
    <div class="time-picker-wrapper">
      <div class="time-picker-stack">
        <div class="time-picker-group">
          <label for="biweekly-hour" class="visually-hidden">Hour</label>
          <input type="number" id="biweekly-hour" min="1" max="12" placeholder="Hours"> :
          <label for="biweekly-minute" class="visually-hidden">Minute</label>
          <input type="number" id="biweekly-minute" min="0" max="59" placeholder="Minutes">
          <select id="biweekly-meridiem">
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </div>
        <label class="time-format-toggle">
          <input type="checkbox" id="biweekly-military">
         Check box to use 24-hour format
        </label>
      </div>
    </div>
  </div>
</div>

        <!-- Monthly options -->
        <div id="monthly-options" class="frequency-options hidden">
          <label><input type="checkbox" id="monthly-specific-days"> Choose specific day(s) of the month</label>
          <div id="monthly-day-container" class="hidden">
            <p class="section-label">Select days (1-31):</p>
            <div class="monthly-days">
              <!-- Dynamically filled with JS (1 to 31) -->
            </div>
            <label style="margin-top: 10px;">
              <input type="checkbox" id="monthly-last-day"> Last day of month
            </label>
          </div>

          <label><input type="checkbox" id="monthly-week-of-month"> Use week of month pattern</label>
          <div id="monthly-week-container" class="hidden">
            <p class="section-label">Select pattern:</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;">
              <select id="monthly-week-ordinal" style="flex: 1; min-width: 100px;">
                <option value="1">1st</option>
                <option value="2">2nd</option>
                <option value="3">3rd</option>
                <option value="4">4th</option>
                <option value="last">Last</option>
              </select>
              <select id="monthly-week-day" style="flex: 1; min-width: 100px;">
                <option value="Sun">Sunday</option>
                <option value="Mon">Monday</option>
                <option value="Tue">Tuesday</option>
                <option value="Wed">Wednesday</option>
                <option value="Thu">Thursday</option>
                <option value="Fri">Friday</option>
                <option value="Sat">Saturday</option>
              </select>
            </div>
          </div>

          <label><input type="checkbox" id="monthly-specific-time"> Choose specific time</label>
          <div id="monthly-time-container" class="hidden">
            <div class="time-picker-wrapper">
              <div class="time-picker-stack">
            <div class="time-picker-group">
              <label for="monthly-hour" class="visually-hidden">Hour</label>
              <input type="number" id="monthly-hour" min="1" max="12" placeholder="Hours">
              :
              <label for="monthly-minute" class="visually-hidden">Minute</label>
              <input type="number" id="monthly-minute" min="0" max="59" placeholder="Minutes">
          
              <select id="monthly-meridiem">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
            <label class="time-format-toggle">
              <input type="checkbox" id="monthly-military"> Check box to use 24-hour format
            </label>
            </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Yearly options -->
      <div id="yearly-options" class="frequency-options hidden" aria-labelledby="yearly-options-heading">
        <h4 id="yearly-options-heading" class="visually-hidden">Yearly recurrence options</h4>
      
        <label>
          <input type="checkbox" id="yearly-specific-months" aria-describedby="yearly-month-container">
          Choose specific month(s)
        </label>
      
        <div id="yearly-month-container" class="hidden" aria-live="polite">
          <p class="section-label">Select months:</p>
          <div class="yearly-months" aria-label="Yearly month options" role="group">
            <!-- These will be dynamically generated -->
          </div>
        </div>
      
        <label id="yearly-specific-days-label" class="hidden">
          <input type="checkbox" id="yearly-specific-days" aria-describedby="yearly-day-container">
          Choose specific day(s) of the month
        </label>
      
        <div id="yearly-day-container" class="hidden" aria-live="polite">
          <p class="section-label">Select days:</p>
      
          <select id="yearly-month-select" aria-label="Month to assign specific days to">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
      
          <label id="yearly-apply-all-label" class="apply-all-label">
            <input type="checkbox" id="yearly-apply-days-to-all" aria-describedby="yearly-apply-description">
            Apply selected days to all selected months
          </label>
          <p id="yearly-apply-description" class="visually-hidden">When checked, all selected days will apply to every selected month.</p>
      
          <div class="yearly-days" aria-label="Specific days of selected month" role="group">
            <!-- Dynamically filled -->
          </div>
        </div>
      
        <label>
          <input type="checkbox" id="yearly-specific-time" aria-controls="yearly-time-container">
          Choose specific time
        </label>
      
        <div id="yearly-time-container" class="hidden" aria-live="polite">
          <div class="time-picker-stack">
            <div class="time-picker-wrapper">
              <div class="time-picker-group" role="group" aria-label="Time of day">
                <label for="yearly-hour" class="visually-hidden">Hour</label>
                <input type="number" id="yearly-hour" min="1" max="12" placeholder="Hours">
                :
                <label for="yearly-minute" class="visually-hidden">Minute</label>
                <input type="number" id="yearly-minute" min="0" max="59" placeholder="Minutes">
                <select id="yearly-meridiem" aria-label="AM or PM">
                  <option value="AM">AM</option>
                  <option value="PM">PM</option>
                </select>
              </div>
      
              <label class="time-format-toggle">
                <input type="checkbox" id="yearly-military" aria-label="Use 24-hour time format">
                Check box to use 24-hour format
              </label>
            </div>
          </div>
        </div>
      </div>

      <div id="set-default-recurring-container">
        <label>
          <input type="checkbox" id="set-default-recurring">
          Set these recurring settings as default
        </label>
      </div>

      <!-- Recurring Summary Preview -->
    <div id="recurring-summary" class="recurring-summary hidden" aria-live="polite">
     
      <!-- This will be filled in dynamically -->
    </div>
      <div id="recur-settings-actions" class="settings-actions">
        <button id="apply-recurring-settings" class="apply-btn">Apply</button>
        <button id="cancel-recurring-settings" class="cancel-btn" type="button">Cancel</button>
      </div>
      </div>
      <button id="close-recurring-panel" class="close-recurring-panel">Close</button>
    </div>
  </div>
</div>


    <div id="games-panel" class="games-modal" data-modal>
        <div class="games-modal-content">
          <h2>üéÆ Games</h2>
          <p>Try to complete tasks in the correct order as fast as you can!</p>
          <button id="open-task-order-game">Play Task Order</button>
          <button id="close-games-panel" class="close-btn">Close</button>
        </div>
         <!-- üéÆ Game Container (initially hidden) -->
 <div id="taskOrderGameContainer" style="display: none;"></div>
      </div>

        <!-- Reminders Modal -->
        <div id="reminders-modal" class="reminders-modal" data-modal>
            <div class="reminders-modal-content">
                <h2>Reminders & Notifications</h2>
        
                <!-- Toggle On/Off -->
                <label class="settings-option">
                    <input type="checkbox" id="enableReminders" />
                    Enable Reminders
                </label>
                <div>
                    <label class="settings-option">
                        <input type="checkbox" id="dueDatesReminders" />
                        Enable Due Date Notifications
                    </label>
                    
                </div>
        
                <!-- Frequency Section (only show if enabled) -->
                <div id="frequency-section">
                    <label>
                        <input type="checkbox" id="indefiniteCheckbox" />
                        Remind Indefinitely?
                    </label>
                    <div id="repeat-count-row">
                        <label for="repeatCount">Number of Times:</label>
                        <input type="number" id="repeatCount" min="1" value="1" />
                    </div>
                    <div id="every-row">
                        <label for="frequencyValue">Every:</label>
                        <input type="number" id="frequencyValue" min="1" value="1" />
                        <select id="frequencyUnit">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                        </select>
                    </div>
                </div>
        
                <!-- Close Button -->
                <button id="close-reminders-btn" class="settings-btn">Close</button>
            </div>
        </div>
        
  

            <!-- Settings Modal -->
        <div class="settings-modal" data-modal>
            <div class="settings-modal-content">
                <h2>Settings</h2>

                <label class="settings-option">
                    <input type="checkbox" id="toggle-move-arrows">
                    Show Move Arrows for Manual Rearranging
                </label>
                
                <label class="settings-option">
                    <input type="checkbox" id="toggle-three-dots">
                    Show Three Dots Menu on Tasks
                </label>

                <label class="settings-option">
              <input type="checkbox" id="always-show-recurring">
              Always Show Recurring Button in Task Options
          </label>

                <label class="settings-option">
                    <input type="checkbox" id="toggle-completed-dropdown">
                    Show Completed Tasks in Dropdown
                </label>

                <!-- Dark Mode Toggle -->
                <label class="settings-option">
                    <input type="checkbox" id="darkModeToggle" />
                    Enable Dark Mode
                </label>

                <!--Reset Onboarding-->
                <button id="reset-onboarding" class="settings-btn">Reset Onboarding</button>

                <!--Reset Notification Position-->
                <button id="reset-notification-position"class="settings-btn">Reset Notification Position</button>

                <!--Reset Recurring Default Settings-->
                <button id="reset-recurring-default"class="settings-btn">Reset Recurring Default</button>

                <!-- Backup & Restore -->
                <button id="backup-mini-cycles" class="settings-btn">üì• Backup All Routines</button>
                <button id="restore-mini-cycles" class="settings-btn">üì§ Restore All Routines</button>

                <!-- Testing Button (for debugging) -->
              <button id="open-testing-modal" class="settings-btn">
                  üî¨ Open App Diagnostics & Testing
              </button>
              <button id="check-for-updates" class="settings-btn">üîÑ Check for Updates</button>
              <button id="try-lite-version" class="settings-btn">üì± Try Lite Version</button>

                <!-- Factory Reset -->
                <button id="factory-reset" class="settings-btn factory-reset-btn">‚ö†Ô∏è Factory Reset</button>

                <!-- Close Button -->
                <button id="close-settings" class="settings-btn close-btn">‚ùå Close</button>
            </div>
        </div>

        <!-- Testing Modal -->
<div id="testing-modal" class="testing-modal" data-modal role="dialog" aria-modal="true" aria-labelledby="testing-modal-title">
    <div class="testing-modal-content">
        <div class="testing-modal-header">
            <h2 id="testing-modal-title">üî¨ App Diagnostics & Testing</h2>
            <button class="close-testing-modal" aria-label="Close testing modal">&times;</button>
        </div>

        <div class="testing-modal-body">
            <!-- Tabs for different testing categories -->
            <div class="testing-tabs">
                <button class="testing-tab active" data-tab="diagnostics">üìä Diagnostics</button>
                <button class="testing-tab" data-tab="migration">üîÑ Migration</button>
                <button class="testing-tab" data-tab="data">üíæ Data Tools</button>
                <button class="testing-tab" data-tab="debug">üêõ Debug Info</button>
                <button class="testing-tab" data-tab="automated-tests">üß™ Automated Tests</button>
            </div>

            <!-- Diagnostics Tab -->
            <div id="diagnostics-tab" class="testing-tab-content active">
                <div class="testing-section">
                    <h3>üìã Quick Health Check</h3>
                    <button id="run-health-check" class="test-btn test-primary">Run Full Diagnostic</button>
                    <button id="check-data-integrity" class="test-btn test-info">Check Data Integrity</button>
                    <button id="validate-schema" class="test-btn test-info">Validate Schema</button>
                </div>

                <div class="testing-section">
                    <h3>üì± App Information</h3>
                    <button id="show-app-info" class="test-btn test-secondary">Show App Details</button>
                    <button id="show-storage-info" class="test-btn test-secondary">Storage Analysis</button>
                    <button id="show-performance-info" class="test-btn test-secondary">Performance Info</button>
                </div>
            </div>

            <!-- Migration Tab -->
            <div id="migration-tab" class="testing-tab-content">
                <div class="testing-section">
                    <h3>üîÑ Migration Status</h3>
                    <button id="check-migration-status" class="test-btn test-primary">Check Migration Needed</button>
                    <button id="test-migration-config" class="test-btn test-info">Test Migration Config</button>
                    <button id="simulate-migration" class="test-btn test-warning">Simulate Migration (Safe)</button>
                </div>

                <div class="testing-section">
                    <h3>üîß Migration Tools</h3>
                    <button id="backup-before-migration" class="test-btn test-success">Create Migration Backup</button>
                    <button id="validate-migration-data" class="test-btn test-info">Validate Migration Data</button>
                    <button id="perform-actual-migration" class="test-btn test-danger">üöÄ Perform Actual Migration</button>
                </div>

                <div class="testing-section">
              <h3>üîí Backup Management</h3>
              <button id="list-available-backups" class="test-btn test-info">List Available Backups</button>
              <button id="restore-from-backup" class="test-btn test-warning">Restore from Backup</button>
              <button id="clean-old-backups" class="test-btn test-secondary">Clean Old Backups</button>
          </div>
            </div>

            <!-- Data Tools Tab -->
            <div id="data-tab" class="testing-tab-content">
                <div class="testing-section">
                    <h3>üìä Data Analysis</h3>
                    <button id="analyze-cycles" class="test-btn test-info">Analyze Cycles</button>
                    <button id="analyze-tasks" class="test-btn test-info">Analyze Tasks</button>
                    <button id="find-data-issues" class="test-btn test-warning">Find Data Issues</button>
                </div>

                <div class="testing-section">
                    <h3>üõ†Ô∏è Data Tools</h3>
                    <button id="export-debug-data" class="test-btn test-success">Export Debug Package</button>
                    <button id="clean-old-data" class="test-btn test-warning">Clean Old Data</button>
                    <button id="repair-data" class="test-btn test-danger">Repair Corrupted Data</button>
                </div>
            </div>

            <!-- Debug Info Tab -->
            <div id="debug-tab" class="testing-tab-content">
                <div class="testing-section">
                    <h3>üêõ Debug Information</h3>
                    <button id="generate-debug-report" class="test-btn test-primary">Generate Debug Report</button>
                    <button id="test-notifications-debug" class="test-btn test-info">Test Notifications</button>
                    <button id="test-recurring-logic" class="test-btn test-info">Test Recurring Logic</button>
                    <button id="view-local-storage-btn" class="test-btn test-secondary">View Local Storage</button>
                    <button id="show-service-worker-info" class="test-btn">üì° Service Worker Info</button>
                    <button id="test-service-worker-update" class="test-btn">üîÑ Test SW Update</button>
                </div>

                <div class="testing-section">
                    <h3>üìã System Info</h3>
                    <button id="show-browser-info" class="test-btn test-secondary">Browser Capabilities</button>
                    <button id="show-feature-flags" class="test-btn test-secondary">Feature Flags</button>
                    <button id="test-localStorage" class="test-btn test-secondary">Test localStorage</button>
                </div>

                                <!-- Add these to your Debug Info tab -->
                <div class="button-group">
                    <h4>üéØ Auto Console Capture</h4>
                    <button id="enable-auto-capture" class="test-btn">üîÑ Enable Auto-Capture Mode</button>
                    <button id="show-all-console-logs" class="test-btn">üìä Show All Captured Logs</button>
                    <button id="show-migration-errors" class="test-btn">üö® Show Migration Issues</button>
                    <button id="clear-all-console-logs" class="test-btn">üßπ Clear All Captured Logs</button>
                    <button id="stop-console-capture" class="test-btn">‚èπÔ∏è Stop Auto Capture</button>
                </div>
            </div>

            <!-- Automated Tests Tab -->
            <div id="automated-tests-tab" class="testing-tab-content">
                <div class="testing-section">
                    <h3>üöÄ Quick Actions</h3>
                    <button id="run-all-automated-tests" class="test-btn test-primary">
                        üèÅ Run All Tests (253 tests)
                    </button>
                    <button id="clear-automated-results" class="test-btn test-clear">
                        üßπ Clear Results
                    </button>
                    <button id="export-automated-results" class="test-btn test-export">
                        üìÑ Export Results
                    </button>
                </div>

                <div class="testing-section">
                    <h3>üé® Theme & UI Tests</h3>
                    <button id="test-thememanager" class="test-btn test-info">
                        üé® ThemeManager (18 tests)
                    </button>
                    <button id="test-globalutils" class="test-btn test-info">
                        üõ†Ô∏è Global Utils (11 tests)
                    </button>
                    <button id="test-notifications" class="test-btn test-info">
                        üîî Notifications (10 tests)
                    </button>
                </div>

                <div class="testing-section">
                    <h3>üì± Core System Tests</h3>
                    <button id="test-devicedetection" class="test-btn test-secondary">
                        üì± DeviceDetection (17 tests)
                    </button>
                    <button id="test-cycleloader" class="test-btn test-secondary">
                        üîÑ CycleLoader (11 tests)
                    </button>
                    <button id="test-state" class="test-btn test-secondary">
                        üíæ State Management (41 tests)
                    </button>
                    <button id="test-consolecapture" class="test-btn test-secondary">
                        ÔøΩ Console Capture (17 tests)
                    </button>
                </div>

                <div class="testing-section">
                    <h3>ÔøΩ Recurring Features</h3>
                    <button id="test-recurringcore" class="test-btn test-warning">
                        üîÅ Recurring Core (37 tests)
                    </button>
                    <button id="test-recurringintegration" class="test-btn test-warning">
                        ÔøΩ Recurring Integration (35 tests)
                    </button>
                    <button id="test-recurringpanel" class="test-btn test-warning">
                        üéõÔ∏è Recurring Panel (31 tests)
                    </button>
                </div>

                <div class="testing-section">
                    <h3>ÔøΩ Analytics & Stats</h3>
                    <button id="test-statspanel" class="test-btn test-success">
                        ÔøΩ Stats Panel (25 tests)
                    </button>
                </div>
            </div>
        </div>
        

        <!-- Results Area -->
        <div class="testing-results-area">
            <div class="testing-results-header">
                <h3>üìù Test Results</h3>
                <div class="testing-results-controls">
                    <button id="clear-test-results" class="test-btn test-clear">Clear</button>
                    <button id="export-test-results" class="test-btn test-export">Export Results</button>
                    <button id="copy-test-results" class="test-btn test-copy">Copy to Clipboard</button>
                </div>
            </div>
            <div id="testing-results" class="testing-results">
                <div id="testing-output" class="testing-output">
                    <div class="welcome-message">
                        <p>üëã Welcome to App Diagnostics!</p>
                        <p>Use the tabs above to run tests and diagnostics.</p>
                        <p>Results will appear here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="testing-modal-footer">
            <div class="testing-modal-info">
               <!--<p><small>üí° Tip: Export results to share with support if you need help</small></p>-->
            </div>
            <button id="close-testing-modal" class="test-btn test-close">Close</button>
        </div>
    </div>
</div>



<!-- Local Storage Viewer Modal -->
<div id="storage-viewer-overlay" class="storage-modal-overlay hidden">
  <div class="storage-modal-box">
    <div class="storage-modal-header">üì¶ Local Storage Viewer</div>
    <div class="storage-modal-body scrollable" id="storage-content">
      <!-- Content injected here -->
    </div>
    <div class="storage-modal-buttons">
      <label style="margin-right: auto; display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="stay-open-toggle" />
        Stay open when clicking outside
      </label>
      <button class="btn-confirm" onclick="closeStorageViewer()">Close</button>
    </div>
  </div>
</div>

<!-- üé® Themes Panel Modal -->
<div class="themes-modal" data-modal id="themes-modal">
    <div class="themes-modal-content">
      <h2>üé® Theme Settings</h2>
  
      <!-- üé® THEME OPTIONS -->
      <div id="theme-options-section">
        <!-- ‚úÖ Theme checkboxes will be inserted here via JS -->
      </div>
  
      <!-- Divider Line -->
      <hr class="theme-divider" />
  
      <!-- üåô Dark Mode Section -->
      <div id="dark-mode-section">
        <label class="custom-checkbox">
          <input type="checkbox" id="darkModeToggleThemes">
          <span class="checkmark"></span>
          Dark Mode üåô
        </label>
      </div>
  
      <button id="close-themes-btn" class="close-btn">Close</button>
    </div>
  </div>



<!-- miniCycle Switch Modal -->
<div class="mini-cycle-switch-modal" data-modal>
    <div class="mini-cycle-switch-modal-content">
        <div class="mini-cycle-switch-title-logo"><img src="assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" alt="Task Cycle Logo" /></div>
        <div class="mini-cycle-switch-title">Open Routine</div>
        <!-- ‚úÖ Scrollable list instead of input -->
        <div class="mini-cycle-switch-list" id="miniCycleList"></div>
        <div id="switch-items-row" class="switch-items-row">
            <button id="switch-rename" class="switch-rename switch-buttons"><i class="fas fa-edit"></i></button>
            <button id="switch-delete" class="switch-delete switch-buttons"><i class="fas fa-trash"></i></button>
            <div id="switch-preview-window" class="switch-preview-window"><br>Preview</div>
        </div>

        <div>
            <button id="miniCycleSwitchConfirm" class="mini-cycle-switch-btn open-btn">Open</button>
            <button id="miniCycleSwitchCancel" class="mini-cycle-switch-btn cancel-btn">Cancel</button>
        </div>
        <div>
            <button id="miniCycleUpload" class="mini-cycle-upload-btn"><i class="fas fa-file-upload"></i> Import From External </button>
        </div>
    </div>
</div>




<!-- Feedback Modal -->
<div id="feedback-modal" class="feedback-modal" data-modal>
    <div class="feedback-modal-content">
        <span class="close-feedback-modal">&times;</span>
        <h2>Provide Feedback</h2>
        <p>We appreciate your feedback! Let us know how we can improve miniCycle.</p>

        <!-- Web3Forms API -->
        <form id="feedback-form" action="https://api.web3forms.com/submit" method="POST">
            <!-- Your Web3Forms Access Key -->
            <input type="hidden" name="access_key" value="691907ec-ad04-4447-9d45-861ee622a091">
            
            <!-- Feedback Text -->
            <textarea id="feedback-text" name="message" placeholder="Write your feedback here..." required></textarea>

            <!-- Email (Optional, if you want users to provide their email) -->
            <input type="email" id="feedback-email" name="email" placeholder="Your Email (optional)" autocomplete="email">

            <!-- Prevent Spam with Honeypot -->
            <input type="text" id="feedback-honeypot" name="honeypot" style="display: none;" autocomplete="off" tabindex="-1">

            <!-- Show a success message instead of redirecting -->
            <button type="submit" id="submit-feedback">Submit</button>
        </form>

        <!-- Thank You Message (Initially Hidden) -->
        <p id="thank-you-message" style="display: none; color: green; font-weight: bold;">
            ‚úÖ Thank you for your feedback!
        </p>
    </div>
</div>





    
    
<div id="app-root" class="app-root" role="application">
  <!--
 <header class="title-container">
    <div class="title-header-inner">
  <div class="title-text">
    <a href="#home" class="logo">
      <img src="assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" alt="Task Cycle Logo" />
    </a>
    <div id="app_name">
      <img src="assets/images/logo/App_Name_tp_bw.png" alt="Task Cycle App Name" />
    </div>   
  <p class="tagline"> Auto Cycle   &#9207;</p>
  </div>

  </div>
</header>!-->




<!-- Task List & Stats Wrapper -->
<main id="app-container" role="main">
          <button id="quick-dark-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
  üåì
</button>
    <!-- Left Arrow for Task View -->
<div id="slide-left" class="slide-arrow" title="Show Stats">‚ùØ</div>

<!-- Right Arrow for Stats Panel -->
<div id="slide-right" class="slide-arrow" title="Show Tasks">‚ùÆ</div>


<div id="task-view">
    <div class="task-input">
  <input type="text" id="taskInput" class="taskInput" placeholder="Enter a task..." title="Type a task and press Add or Enter">
  <button id="addTaskBtn" title="Add task">Add</button>
    </div>
    <div id="mini-cycle-title" class="mini-cycle-title" contenteditable="true"></div>
    <div class="task-list-container">
        <!--Tasks will go here-->
        <ul id="taskList" class="task-list"></ul>

        <!-- Completed Tasks Collapsible Section -->
        <div class="completed-tasks-section" id="completed-tasks-section">
            <h3 class="completed-tasks-header clickable" id="completed-tasks-header">
                ‚úì Completed (<span id="completed-count">0</span>) <span class="toggle-icon">‚ñº</span>
            </h3>
            <ul id="completedTaskList" class="completed-task-list"></ul>
        </div>
    </div>
    <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>
    <div id="complete-all-and-help-window-container" class="complete-all-and-help-window-container">
        <!-- Complete All Button -->
  <button id="completeAll" class="complete-all-btn" title="Complete all checked tasks">Complete</button>
        <!-- Mini Cycle Help Window -->
        <div id="help-window" class="help-window">
            <!--Messages will appear here-->
        </div>
    </div>
</div>



    <!-- Stats Panel (Initially Hidden) -->
    <section id="stats-panel" class="stats-panel" role="region" aria-labelledby="stats-header">
        <h2 id="stats-header">üìä Stats</h2>
        <div class="current-routine-status" id="current-routine-status">
            <h3 class="clickable">
                üìã Current Routine <span class="toggle-icon">‚ñº</span>
            </h3>
            <!-- Collapsible Details -->
            <div id="current-cycle-doughnut-container" class="current-cycle-doughnut-container">
                <svg class="current-cycle-doughnut" viewBox="0 0 100 100" role="img" aria-label="Current cycle task completion">
                    <!-- Background circle (gray) -->
                    <circle class="doughnut-bg" cx="50" cy="50" r="40" fill="none" stroke="#e0e0e0" stroke-width="12"/>
                    <!-- Progress circle (green) -->
                    <circle id="current-cycle-doughnut-progress" class="doughnut-progress" cx="50" cy="50" r="40" fill="none" stroke="url(#gradient)" stroke-width="12" stroke-linecap="round" transform="rotate(-90 50 50)"/>
                    <!-- Gradient definition -->
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#4caf50;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#66bb6a;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- Center text (percentage) -->
                    <text id="current-cycle-doughnut-text" x="50" y="55" text-anchor="middle" class="doughnut-text">0%</text>
                </svg>
            </div>
            <p id="current-cycle-progress-text">0 of 0 Tasks Completed</p>
            <p id="current-routine-cycle-count"><span id="per-cycle-count">0 Cycles Completed</span></p>
        </div>
                  <div class="theme-unlock-status" id="theme-unlock-status">
            <h3 class="clickable">
                üéØ Milestone Rewards <span class="toggle-icon">‚ñº</span>
              </h3>
            <p id="theme-unlock-message">Loading...</p>
            <p id="golden-unlock-message">Loading...</p>
            <p id="game-unlock-message">Loading game unlock info...</p>
          </div>
        <div class="badge-container">
            <h3>üèÖ Achievement Badges</h3>
            <div class="badges">
                <div class="badge" data-milestone="5" title="5 total cycles across all routines - Unlocks Dark Ocean Theme">5</div>
              <div class="badge" data-milestone="25" title="25 total cycles across all routines">25</div>
              <div class="badge" data-milestone="50" title="50 total cycles across all routines - Unlocks Golden Glow Theme">50</div>
              <div class="badge" data-milestone="75" title="75 total cycles across all routines">75</div>
              <div class="badge" data-milestone="100" title="100 total cycles across all routines - Unlocks Task Order Game!">üíØ</div>
            </div>
          </div>

        <p id="all-routines-count"><strong>All Routines:</strong> <span id="mini-cycle-count">0 Cycles</span></p>
        <p><strong>Progress to Next Milestone:</strong></p>
        <p id="milestone-progress-text" style="font-size: 0.9em; color: #666; margin-top: -8px;">Loading...</p>
        <div class="progress-container">
            <div id="stats-progress-bar" class="progress-bar" role="progressbar" aria-label="Progress to next milestone"></div>
        </div>
    </section>

    
</main>

    
</div>



<div>
<footer id="footer-container" role="contentinfo">
<!-- ‚úÖ Undo buttons here will group them logically with header -->
<div id="undo-redo-buttons" class="undo-container">
<button id="undo-btn" class="undo-redo-btn" hidden title="Undo last action">Undo</button>
<button id="redo-btn" class="undo-redo-btn" hidden title="Redo last undone action">Redo</button>
</div>

<nav id="nav-dots" class="navigation-dots" role="tablist" aria-label="Page navigation">
<button class="dot active" role="tab" aria-selected="true" aria-controls="task-view" aria-label="Tasks view" title="Tasks view">
<span class="visually-hidden">Tasks</span>
</button>
<button class="dot" role="tab" aria-selected="false" aria-controls="stats-panel" aria-label="Statistics view" title="Statistics view">
<span class="visually-hidden">Stats</span>
</button>
</nav>
<ul class="footer-links" style="list-style: none; padding: 0; margin: 0 auto; display: flex; justify-content: center; align-items: center; width: fit-content;">
<li id="copyright">
  &copy; 2025 <a href="https://sparkincreations.com" target="_blank" rel="noopener noreferrer" title="Visit sparkinCreations website">sparkinCreations</a>
  &bull;
  <a href="pages/product.html" target="_blank" rel="noopener noreferrer" aria-label="miniCycle product page" title="Open the miniCycle product page">miniCycle<sup>‚Ñ¢</sup></a>
</li>
<li class="footer-item"><a href="legal/privacy.html" target="_blank" rel="noopener noreferrer" title="Read the Privacy Policy">Privacy Policy</a></li>
<li class="footer-item"><a href="legal/terms.html" target="_blank" rel="noopener noreferrer" title="Read the Terms of Service">Terms of Service</a></li>
<li class="footer-item">
<a href="#" id="open-feedback-modal-footer" class="open-feedback-modal-footer" role="button" aria-label="Open feedback modal" title="Send us feedback">
Feedback
</a>
</li>
</ul>
</footer>
      
</div>




<!-- üîä ARIA Live Region for announcing view changes -->
<div id="live-region" aria-live="polite" style="position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden;"></div>

 <script type="module" src="miniCycle-scripts.js?v=1.355"></script>

<script>
// Sync About modal version with meta app-version
document.addEventListener('DOMContentLoaded', function () {
  var meta = document.querySelector('meta[name="app-version"]');
  var aboutSpan = document.getElementById('about-version');
  if (meta && aboutSpan) {
    aboutSpan.textContent = meta.getAttribute('content') || '‚Äî';
  }
  // Populate SW version in About modal
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(function (reg) {
      if (!reg || !reg.active) return;
      var ch = new MessageChannel();
      ch.port1.onmessage = function (evt) {
        var swSpan = document.getElementById('about-sw-version');
        if (swSpan && evt.data) {
          swSpan.textContent = evt.data.version || 'Unknown';
        }
      };
      try { reg.active.postMessage({ type: 'GET_VERSION' }, [ch.port2]); } catch (e) {}
    }).catch(function(){});
  }

  // Wire "Check for Updates" button
  var btn = document.getElementById('check-for-updates');
  if (btn) {
    btn.addEventListener('click', function () {
      if (typeof window.forceServiceWorkerUpdate === 'function') {
        window.forceServiceWorkerUpdate();
      } else if (typeof window.checkForUpdates === 'function') {
        window.checkForUpdates();
      }
    });
  }
});
</script>
   <!-- Testing modules now loaded dynamically in miniCycle-scripts.js -->
   <script src="modules/testing/automated-tests-fix.js?v=1.355"></script>
   <script>
// Late fallback: only redirect if feature gate failed OR full app never even started booting.
(function () {
  if (location.search.indexOf('mode=full') !== -1) return; // user forced full
  setTimeout(function () {
    var needsLite = !!window.__FeatureGateNeedsLite; // default false if gate script didn't run
    if (needsLite) {
      location.replace('./lite/miniCycle-lite.html?mode=lite&src=fallback');
      return;
    }
    // If full app has begun booting, don't redirect even if AppReady isn't set yet (e.g., onboarding).
    if (window.AppBootStarted) {
      console.warn('Full mode boot started; skipping lite fallback.');
      return;
    }
    // Last resort: no boot detected at all.
    location.replace('./lite/miniCycle-lite.html?mode=lite&src=no-boot');
  }, 8000);
})();
</script>
</body>
</html>