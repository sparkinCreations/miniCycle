<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#5680ff">
    <title>üß™ miniCycle Module Test Suite</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #4c79ff, #74c0fc);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: white;
        }

        body {
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .module-selector {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: white;
        }

        select:focus {
            outline: none;
            border-color: white;
            background: white;
        }

        button {
            background: rgba(255, 255, 255, 0.95);
            color: #4c79ff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px 0 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
        }

        button:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        #results {
            margin-top: 30px;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 25px 0 15px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 20px 0 15px;
            opacity: 0.95;
        }

        .test-section {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 25px 0 10px;
            padding: 8px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .result {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 0.95rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .result:hover {
            transform: translateX(4px);
        }

        .pass {
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .fail {
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .test-element,
        #test-element,
        #test-element-2,
        .selector-test {
            display: none !important;
            visibility: hidden !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
            }

            .module-selector {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ miniCycle Module Test Suite</h1>
        <p class="subtitle">Simple browser tests for miniCycle modules.</p>

    <div class="module-selector">
        <label for="module-select">Choose a module to test:</label>
        <select id="module-select">
            <option value="">-- Select Module --</option>
            <option value="integration">üîó Integration Tests (E2E)</option>
            <option value="themeManager">ThemeManager</option>
            <option value="deviceDetection">DeviceDetection</option>
            <option value="cycleLoader">CycleLoader</option>
            <option value="statsPanel">StatsPanel</option>
            <option value="consoleCapture">ConsoleCapture</option>
            <option value="state">State</option>
            <option value="recurringCore">RecurringCore</option>
            <option value="recurringIntegration">RecurringIntegration</option>
            <option value="recurringPanel">RecurringPanel</option>
            <option value="globalUtils">GlobalUtils</option>
            <option value="notifications">Notifications</option>
            <option value="dragDropManager">DragDropManager</option>
            <option value="migrationManager">MigrationManager</option>
            <option value="dueDates">Due Dates</option>
            <option value="reminders">Reminders</option>
            <option value="modeManager">ModeManager</option>
            <option value="cycleSwitcher">CycleSwitcher</option>
            <option value="undoRedoManager">UndoRedoManager</option>
            <option value="gamesManager">GamesManager</option>
            <option value="onboardingManager">OnboardingManager</option>
            <option value="modalManager">ModalManager</option>
            <option value="menuManager">MenuManager</option>
            <option value="settingsManager">SettingsManager</option>
            <option value="taskCore">TaskCore</option>
            <option value="taskValidation">TaskValidation</option>
            <option value="taskUtils">TaskUtils</option>
            <option value="taskRenderer">TaskRenderer</option>
            <option value="taskEvents">TaskEvents</option>
            <option value="taskDOM">TaskDOM</option>
        </select>
        <button id="run-tests-btn">Run Tests</button>
        <button id="run-all-tests-btn">‚ñ∂Ô∏è Run All Tests (30 modules)</button>
        <button id="copy-results-btn" style="display: none;">üìã Copy Results</button>
    </div>

    <div id="results"></div>

    <!-- Test Elements -->
    <div id="test-element" class="test-element">Test Element</div>
    <div id="test-element-2" class="test-element">Test Element 2</div>
    <div class="selector-test test-element">Selector 1</div>
    <div class="selector-test test-element">Selector 2</div>
    <div class="selector-test test-element">Selector 3</div>

    <script type="module">
        // Cache-busting timestamp to force fresh module loads during development
        const cacheBuster = Date.now();

        // Import test modules with cache busting
        const { runIntegrationTests } = await import(`./integration.tests.js?v=${cacheBuster}`);
        const { runThemeManagerTests } = await import(`./themeManager.tests.js?v=${cacheBuster}`);
        const { runDeviceDetectionTests } = await import(`./deviceDetection.tests.js?v=${cacheBuster}`);
        const { runCycleLoaderTests } = await import(`./cycleLoader.tests.js?v=${cacheBuster}`);
        const { runStatsPanelTests } = await import(`./statsPanel.tests.js?v=${cacheBuster}`);
        const { runConsoleCaptureTests } = await import(`./consoleCapture.tests.js?v=${cacheBuster}`);
        const { runStateTests } = await import(`./state.tests.js?v=${cacheBuster}`);
        const { runRecurringCoreTests } = await import(`./recurringCore.tests.js?v=${cacheBuster}`);
        const { runRecurringIntegrationTests } = await import(`./recurringIntegration.tests.js?v=${cacheBuster}`);
        const { runRecurringPanelTests } = await import(`./recurringPanel.tests.js?v=${cacheBuster}`);
        const { runGlobalUtilsTests } = await import(`./globalUtils.tests.js?v=${cacheBuster}`);
        const { runNotificationsTests } = await import(`./notifications.tests.js?v=${cacheBuster}`);
        const { runDragDropManagerTests } = await import(`./dragDropManager.tests.js?v=${cacheBuster}`);
        const { runMigrationManagerTests } = await import(`./migrationManager.tests.js?v=${cacheBuster}`);
        const { runDueDatesTests } = await import(`./dueDates.tests.js?v=${cacheBuster}`);
        const { runRemindersTests } = await import(`./reminders.tests.js?v=${cacheBuster}`);
        const { runModeManagerTests } = await import(`./modeManager.tests.js?v=${cacheBuster}`);
        const { runCycleSwitcherTests } = await import(`./cycleSwitcher.tests.js?v=${cacheBuster}`);
        const { runUndoRedoManagerTests } = await import(`./undoRedoManager.tests.js?v=${cacheBuster}`);
        const { runGamesManagerTests } = await import(`./gamesManager.tests.js?v=${cacheBuster}`);
        const { runOnboardingManagerTests } = await import(`./onboardingManager.tests.js?v=${cacheBuster}`);
        const { runModalManagerTests } = await import(`./modalManager.tests.js?v=${cacheBuster}`);
        const { runMenuManagerTests } = await import(`./menuManager.tests.js?v=${cacheBuster}`);
        const { runSettingsManagerTests } = await import(`./settingsManager.tests.js?v=${cacheBuster}`);
        const { runTaskCoreTests } = await import(`./taskCore.tests.js?v=${cacheBuster}`);
        const { runTaskValidationTests } = await import(`./taskValidation.tests.js?v=${cacheBuster}`);
        const { runTaskUtilsTests } = await import(`./taskUtils.tests.js?v=${cacheBuster}`);
        const { runTaskRendererTests } = await import(`./taskRenderer.tests.js?v=${cacheBuster}`);
        const { runTaskEventsTests } = await import(`./taskEvents.tests.js?v=${cacheBuster}`);
        const { runTaskDOMTests } = await import(`./taskDOM.tests.js?v=${cacheBuster}`);

        let currentModule = null;

        const moduleSelect = document.getElementById('module-select');
        const runTestsBtn = document.getElementById('run-tests-btn');
        const runAllTestsBtn = document.getElementById('run-all-tests-btn');
        const copyResultsBtn = document.getElementById('copy-results-btn');
        const resultsDiv = document.getElementById('results');

        // Load selected module
        moduleSelect.addEventListener('change', async (e) => {
            const moduleName = e.target.value;
            if (!moduleName) return;

            resultsDiv.innerHTML = '<p>Loading module...</p>';

            try {
                // Use cache buster for module imports to force fresh loads
                if (moduleName === 'integration') {
                    // Integration tests don't need to import any modules - they test the whole app
                    currentModule = 'integration';
                    resultsDiv.innerHTML = '<p>‚úÖ Integration Tests (E2E) ready. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'themeManager') {
                    await import(`../utilities/themeManager.js?v=${cacheBuster}`);
                    currentModule = 'themeManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ThemeManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'deviceDetection') {
                    await import(`../utilities/deviceDetection.js?v=${cacheBuster}`);
                    currentModule = 'deviceDetection';
                    resultsDiv.innerHTML = '<p>‚úÖ DeviceDetection loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'cycleLoader') {
                    await import(`../utilities/cycle/cycleLoader.js?v=${cacheBuster}`);
                    currentModule = 'cycleLoader';
                    resultsDiv.innerHTML = '<p>‚úÖ CycleLoader loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'statsPanel') {
                    await import(`../utilities/statsPanel.js?v=${cacheBuster}`);
                    currentModule = 'statsPanel';
                    resultsDiv.innerHTML = '<p>‚úÖ StatsPanel loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'consoleCapture') {
                    await import(`../utilities/consoleCapture.js?v=${cacheBuster}`);
                    currentModule = 'consoleCapture';
                    resultsDiv.innerHTML = '<p>‚úÖ ConsoleCapture loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'state') {
                    await import(`../utilities/state.js?v=${cacheBuster}`);
                    currentModule = 'state';
                    resultsDiv.innerHTML = '<p>‚úÖ State loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringCore') {
                    await import(`../utilities/recurringCore.js?v=${cacheBuster}`);
                    currentModule = 'recurringCore';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringCore loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringIntegration') {
                    await import(`../utilities/recurringIntegration.js?v=${cacheBuster}`);
                    currentModule = 'recurringIntegration';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringIntegration loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringPanel') {
                    await import(`../utilities/recurringPanel.js?v=${cacheBuster}`);
                    currentModule = 'recurringPanel';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringPanel loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'globalUtils') {
                    await import(`../utilities/globalUtils.js?v=${cacheBuster}`);
                    currentModule = 'globalUtils';
                    resultsDiv.innerHTML = '<p>‚úÖ GlobalUtils loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'notifications') {
                    await import(`../utilities/notifications.js?v=${cacheBuster}`);
                    currentModule = 'notifications';
                    resultsDiv.innerHTML = '<p>‚úÖ Notifications loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'dragDropManager') {
                    await import(`../utilities/task/dragDropManager.js?v=${cacheBuster}`);
                    currentModule = 'dragDropManager';
                    resultsDiv.innerHTML = '<p>‚úÖ DragDropManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'migrationManager') {
                    await import(`../utilities/cycle/migrationManager.js?v=${cacheBuster}`);
                    currentModule = 'migrationManager';
                    resultsDiv.innerHTML = '<p>‚úÖ MigrationManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'dueDates') {
                    await import(`../utilities/dueDates.js?v=${cacheBuster}`);
                    currentModule = 'dueDates';
                    resultsDiv.innerHTML = '<p>‚úÖ Due Dates loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'reminders') {
                    await import(`../utilities/reminders.js?v=${cacheBuster}`);
                    currentModule = 'reminders';
                    resultsDiv.innerHTML = '<p>‚úÖ Reminders loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'modeManager') {
                    await import(`../utilities/cycle/modeManager.js?v=${cacheBuster}`);
                    currentModule = 'modeManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ModeManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'cycleSwitcher') {
                    await import(`../utilities/cycle/cycleSwitcher.js?v=${cacheBuster}`);
                    currentModule = 'cycleSwitcher';
                    resultsDiv.innerHTML = '<p>‚úÖ CycleSwitcher loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'undoRedoManager') {
                    await import(`../utilities/ui/undoRedoManager.js?v=${cacheBuster}`);
                    currentModule = 'undoRedoManager';
                    resultsDiv.innerHTML = '<p>‚úÖ UndoRedoManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'gamesManager') {
                    await import(`../utilities/ui/gamesManager.js?v=${cacheBuster}`);
                    currentModule = 'gamesManager';
                    resultsDiv.innerHTML = '<p>‚úÖ GamesManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'onboardingManager') {
                    await import(`../utilities/ui/onboardingManager.js?v=${cacheBuster}`);
                    currentModule = 'onboardingManager';
                    resultsDiv.innerHTML = '<p>‚úÖ OnboardingManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'modalManager') {
                    await import(`../utilities/ui/modalManager.js?v=${cacheBuster}`);
                    currentModule = 'modalManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ModalManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'menuManager') {
                    await import(`../utilities/ui/menuManager.js?v=${cacheBuster}`);
                    currentModule = 'menuManager';
                    resultsDiv.innerHTML = '<p>‚úÖ MenuManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'settingsManager') {
                    await import(`../utilities/ui/settingsManager.js?v=${cacheBuster}`);
                    currentModule = 'settingsManager';
                    resultsDiv.innerHTML = '<p>‚úÖ SettingsManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskCore') {
                    const { initTaskCore } = await import(`../utilities/task/taskCore.js?v=${cacheBuster}`);
                    // Initialize with test-friendly mocks to avoid prompts
                    await initTaskCore({
                        showPromptModal: (options) => {
                            console.log('[TEST] Mock prompt:', options.message);
                            // Auto-provide a test value to avoid blocking tests
                            if (options.callback) options.callback('Test Task');
                        },
                        showConfirmationModal: (options) => {
                            console.log('[TEST] Mock confirmation:', options.message);
                            // Auto-confirm to avoid blocking tests
                            if (options.confirmCallback) options.confirmCallback();
                        }
                    });
                    currentModule = 'taskCore';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskCore loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskValidation') {
                    await import(`../utilities/task/taskValidation.js?v=${cacheBuster}`);
                    currentModule = 'taskValidation';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskValidation loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskUtils') {
                    await import(`../utilities/task/taskUtils.js?v=${cacheBuster}`);
                    currentModule = 'taskUtils';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskUtils loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskRenderer') {
                    await import(`../utilities/task/taskRenderer.js?v=${cacheBuster}`);
                    currentModule = 'taskRenderer';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskRenderer loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskEvents') {
                    await import(`../utilities/task/taskEvents.js?v=${cacheBuster}`);
                    currentModule = 'taskEvents';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskEvents loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskDOM') {
                    // Load globalUtils first (provides window.sanitizeInput needed by validator)
                    await import(`../utilities/globalUtils.js?v=${cacheBuster}`);
                    await import(`../utilities/task/taskDOM.js?v=${cacheBuster}`);
                    currentModule = 'taskDOM';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskDOM loaded (with globalUtils). Click "Run Tests" to begin.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result fail">‚ùå Failed to load module: ${error.message}</div>`;
            }
        });

        // Run tests (async to handle async test functions)
        runTestsBtn.addEventListener('click', async () => {
            if (!currentModule) {
                resultsDiv.innerHTML = '<div class="result fail">‚ùå Please select a module first</div>';
                return;
            }

            if (currentModule === 'integration') {
                await runIntegrationTests(resultsDiv);
            } else if (currentModule === 'themeManager') {
                await runThemeManagerTests(resultsDiv);
            } else if (currentModule === 'deviceDetection') {
                await runDeviceDetectionTests(resultsDiv);
            } else if (currentModule === 'cycleLoader') {
                await runCycleLoaderTests(resultsDiv);
            } else if (currentModule === 'statsPanel') {
                await runStatsPanelTests(resultsDiv);
            } else if (currentModule === 'consoleCapture') {
                await runConsoleCaptureTests(resultsDiv);
            } else if (currentModule === 'state') {
                await runStateTests(resultsDiv);
            } else if (currentModule === 'recurringCore') {
                await runRecurringCoreTests(resultsDiv);
            } else if (currentModule === 'recurringIntegration') {
                await runRecurringIntegrationTests(resultsDiv);
            } else if (currentModule === 'recurringPanel') {
                await runRecurringPanelTests(resultsDiv);
            } else if (currentModule === 'globalUtils') {
                await runGlobalUtilsTests(resultsDiv);
            } else if (currentModule === 'notifications') {
                await runNotificationsTests(resultsDiv);
            } else if (currentModule === 'dragDropManager') {
                await runDragDropManagerTests(resultsDiv);
            } else if (currentModule === 'migrationManager') {
                await runMigrationManagerTests(resultsDiv);
            } else if (currentModule === 'dueDates') {
                await runDueDatesTests(resultsDiv);
            } else if (currentModule === 'reminders') {
                await runRemindersTests(resultsDiv);
            } else if (currentModule === 'modeManager') {
                await runModeManagerTests(resultsDiv);
            } else if (currentModule === 'cycleSwitcher') {
                await runCycleSwitcherTests(resultsDiv);
            } else if (currentModule === 'undoRedoManager') {
                await runUndoRedoManagerTests(resultsDiv);
            } else if (currentModule === 'gamesManager') {
                await runGamesManagerTests(resultsDiv);
            } else if (currentModule === 'onboardingManager') {
                await runOnboardingManagerTests(resultsDiv);
            } else if (currentModule === 'modalManager') {
                await runModalManagerTests(resultsDiv);
            } else if (currentModule === 'menuManager') {
                await runMenuManagerTests(resultsDiv);
            } else if (currentModule === 'settingsManager') {
                await runSettingsManagerTests(resultsDiv);
            } else if (currentModule === 'taskCore') {
                await runTaskCoreTests(resultsDiv);
            } else if (currentModule === 'taskValidation') {
                await runTaskValidationTests(resultsDiv);
            } else if (currentModule === 'taskUtils') {
                await runTaskUtilsTests(resultsDiv);
            } else if (currentModule === 'taskRenderer') {
                await runTaskRendererTests(resultsDiv);
            } else if (currentModule === 'taskEvents') {
                await runTaskEventsTests(resultsDiv);
            } else if (currentModule === 'taskDOM') {
                await runTaskDOMTests(resultsDiv);
            }

            // Show copy button after tests run
            copyResultsBtn.style.display = 'inline-block';
        });

        // Copy results to clipboard
        copyResultsBtn.addEventListener('click', async () => {
            try {
                const textResults = convertResultsToText();
                await navigator.clipboard.writeText(textResults);

                // Show feedback
                const originalText = copyResultsBtn.textContent;
                copyResultsBtn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    copyResultsBtn.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Failed to copy:', error);
                alert('Failed to copy results to clipboard');
            }
        });

        // Run all tests
        runAllTestsBtn.addEventListener('click', async () => {
            const startTime = performance.now();

            resultsDiv.innerHTML = '<h2>üß™ Running All Tests...</h2><p>This may take a few moments...</p>';
            copyResultsBtn.style.display = 'none';

            // üîí SAVE REAL APP DATA ONCE before all tests run
            const savedRealData = {};
            const protectedKeys = ['miniCycleData', 'miniCycleForceFullVersion'];
            protectedKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    savedRealData[key] = value;
                }
            });
            console.log('üîí Saved original localStorage before running all tests');

            // Define all modules and their test functions
            const allModules = [
                { name: 'üîó Integration (E2E)', key: 'integration', runFn: runIntegrationTests, importPath: null },
                { name: 'ThemeManager', key: 'themeManager', runFn: runThemeManagerTests, importPath: '../utilities/themeManager.js' },
                { name: 'DeviceDetection', key: 'deviceDetection', runFn: runDeviceDetectionTests, importPath: '../utilities/deviceDetection.js' },
                { name: 'CycleLoader', key: 'cycleLoader', runFn: runCycleLoaderTests, importPath: '../utilities/cycle/cycleLoader.js' },
                { name: 'StatsPanel', key: 'statsPanel', runFn: runStatsPanelTests, importPath: '../utilities/statsPanel.js' },
                { name: 'ConsoleCapture', key: 'consoleCapture', runFn: runConsoleCaptureTests, importPath: '../utilities/consoleCapture.js' },
                { name: 'State', key: 'state', runFn: runStateTests, importPath: '../utilities/state.js' },
                { name: 'RecurringCore', key: 'recurringCore', runFn: runRecurringCoreTests, importPath: '../utilities/recurringCore.js' },
                { name: 'RecurringIntegration', key: 'recurringIntegration', runFn: runRecurringIntegrationTests, importPath: '../utilities/recurringIntegration.js' },
                { name: 'RecurringPanel', key: 'recurringPanel', runFn: runRecurringPanelTests, importPath: '../utilities/recurringPanel.js' },
                { name: 'GlobalUtils', key: 'globalUtils', runFn: runGlobalUtilsTests, importPath: '../utilities/globalUtils.js' },
                { name: 'Notifications', key: 'notifications', runFn: runNotificationsTests, importPath: '../utilities/notifications.js' },
                { name: 'DragDropManager', key: 'dragDropManager', runFn: runDragDropManagerTests, importPath: '../utilities/task/dragDropManager.js' },
                { name: 'MigrationManager', key: 'migrationManager', runFn: runMigrationManagerTests, importPath: '../utilities/cycle/migrationManager.js' },
                { name: 'DueDates', key: 'dueDates', runFn: runDueDatesTests, importPath: '../utilities/dueDates.js' },
                { name: 'Reminders', key: 'reminders', runFn: runRemindersTests, importPath: '../utilities/reminders.js' },
                { name: 'MenuManager', key: 'menuManager', runFn: runMenuManagerTests, importPath: '../utilities/ui/menuManager.js' },
                { name: 'SettingsManager', key: 'settingsManager', runFn: runSettingsManagerTests, importPath: '../utilities/ui/settingsManager.js' },
                { name: 'ModeManager', key: 'modeManager', runFn: runModeManagerTests, importPath: '../utilities/cycle/modeManager.js' },
                { name: 'CycleSwitcher', key: 'cycleSwitcher', runFn: runCycleSwitcherTests, importPath: '../utilities/cycle/cycleSwitcher.js' },
                { name: 'UndoRedoManager', key: 'undoRedoManager', runFn: runUndoRedoManagerTests, importPath: '../utilities/ui/undoRedoManager.js' },
                { name: 'GamesManager', key: 'gamesManager', runFn: runGamesManagerTests, importPath: '../utilities/ui/gamesManager.js' },
                { name: 'OnboardingManager', key: 'onboardingManager', runFn: runOnboardingManagerTests, importPath: '../utilities/ui/onboardingManager.js' },
                { name: 'ModalManager', key: 'modalManager', runFn: runModalManagerTests, importPath: '../utilities/ui/modalManager.js' },
                { name: 'TaskCore', key: 'taskCore', runFn: runTaskCoreTests, importPath: '../utilities/task/taskCore.js' },
                { name: 'TaskValidation', key: 'taskValidation', runFn: runTaskValidationTests, importPath: '../utilities/task/taskValidation.js' },
                { name: 'TaskUtils', key: 'taskUtils', runFn: runTaskUtilsTests, importPath: '../utilities/task/taskUtils.js' },
                { name: 'TaskRenderer', key: 'taskRenderer', runFn: runTaskRendererTests, importPath: '../utilities/task/taskRenderer.js' },
                { name: 'TaskEvents', key: 'taskEvents', runFn: runTaskEventsTests, importPath: '../utilities/task/taskEvents.js' },
                { name: 'TaskDOM', key: 'taskDOM', runFn: runTaskDOMTests, importPath: '../utilities/task/taskDOM.js' }
            ];

            let allResults = [];
            let totalPassed = 0;
            let totalTests = 0;

            // Run each module's tests
            for (const module of allModules) {
                try {
                    // Load the module (skip for integration tests which don't need imports)
                    if (module.importPath) {
                        if (module.key === 'taskCore') {
                            // TaskCore needs special initialization with test-friendly mocks
                            const { initTaskCore } = await import(`${module.importPath}?v=${cacheBuster}`);
                            await initTaskCore({
                                showPromptModal: (options) => {
                                    console.log('[TEST] Mock prompt:', options.message);
                                    if (options.callback) options.callback('Test Task');
                                },
                                showConfirmationModal: (options) => {
                                    console.log('[TEST] Mock confirmation:', options.message);
                                    if (options.confirmCallback) options.confirmCallback();
                                }
                            });
                        } else {
                            await import(`${module.importPath}?v=${cacheBuster}`);
                        }
                    }

                    // Create a temporary div for results
                    const tempDiv = document.createElement('div');

                    // Run the tests (pass isPartOfSuite=true for tests that manage localStorage)
                    let result;
                    if (module.key === 'integration') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'state') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'cycleLoader') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'deviceDetection') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'migrationManager') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else {
                        result = await module.runFn(tempDiv);
                    }

                    // Store results
                    allResults.push({
                        name: module.name,
                        passed: result?.passed || 0,
                        total: result?.total || 0,
                        html: tempDiv.innerHTML
                    });

                    totalPassed += (result?.passed || 0);
                    totalTests += (result?.total || 0);

                } catch (error) {
                    allResults.push({
                        name: module.name,
                        passed: 0,
                        total: 0,
                        error: error.message,
                        html: `<div class="result fail">‚ùå Failed to run tests: ${error.message}</div>`
                    });
                }
            }

            const endTime = performance.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            // Display aggregated results
            let output = '<h2>üß™ All Module Test Results</h2>';
            output += `<h3>Completed in ${duration}s</h3>`;

            // Summary table
            output += '<div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; margin: 20px 0; color: #333;">';
            output += '<h3 style="color: #333; margin-top: 0;">üìä Summary</h3>';
            output += '<table style="width: 100%; border-collapse: collapse;">';
            output += '<thead><tr style="border-bottom: 2px solid #ddd;"><th style="text-align: left; padding: 8px;">Module</th><th style="text-align: right; padding: 8px;">Passed</th><th style="text-align: right; padding: 8px;">Total</th><th style="text-align: right; padding: 8px;">Status</th></tr></thead>';
            output += '<tbody>';

            for (const result of allResults) {
                const passRate = result.total > 0 ? (result.passed / result.total * 100).toFixed(0) : 0;
                const statusEmoji = result.passed === result.total ? '‚úÖ' : '‚ùå';
                const rowColor = result.passed === result.total ? '#d4edda' : '#f8d7da';

                output += `<tr style="border-bottom: 1px solid #eee; background: ${rowColor};">`;
                output += `<td style="padding: 8px; font-weight: 600;">${result.name}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${result.passed}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${result.total}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${statusEmoji} ${passRate}%</td>`;
                output += '</tr>';
            }

            output += '</tbody>';
            output += '<tfoot><tr style="border-top: 2px solid #333; font-weight: bold; background: #e9ecef;"><td style="padding: 8px;">TOTAL</td><td style="text-align: right; padding: 8px;">' + totalPassed + '</td><td style="text-align: right; padding: 8px;">' + totalTests + '</td><td style="text-align: right; padding: 8px;">' + (totalPassed === totalTests ? '‚úÖ' : '‚ùå') + ' ' + (totalTests > 0 ? (totalPassed / totalTests * 100).toFixed(0) : 0) + '%</td></tr></tfoot>';
            output += '</table>';
            output += '</div>';

            // Detailed results for each module
            output += '<h3 style="margin-top: 30px;">üìã Detailed Results</h3>';
            for (const result of allResults) {
                output += '<div style="margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">';
                output += `<h4 style="margin-top: 0;">${result.name} (${result.passed}/${result.total})</h4>`;
                output += result.html;
                output += '</div>';
            }

            resultsDiv.innerHTML = output;
            copyResultsBtn.style.display = 'inline-block';

            // ‚è±Ô∏è WAIT for any debounced saves to complete (700ms safety margin)
            await new Promise(resolve => setTimeout(resolve, 700));

            // üîí RESTORE REAL APP DATA after all tests complete (GUARANTEED)
            localStorage.clear();
            Object.keys(savedRealData).forEach(key => {
                localStorage.setItem(key, savedRealData[key]);
            });
            console.log('‚úÖ All tests completed - original localStorage restored');
        });

        // Convert HTML results to plain text format
        function convertResultsToText() {
            const h2 = resultsDiv.querySelector('h2');
            const h3 = resultsDiv.querySelector('h3');

            let text = '='.repeat(80) + '\n';
            text += h2 ? h2.textContent + '\n' : 'Test Results\n';
            text += '='.repeat(80) + '\n\n';

            // Check if this is "Run All Tests" results (has a table)
            const summaryTable = resultsDiv.querySelector('table');

            if (summaryTable) {
                // This is "Run All Tests" format
                if (h3) {
                    text += h3.textContent + '\n\n';
                }

                // Extract table data
                text += 'üìä SUMMARY\n';
                text += '-'.repeat(80) + '\n';
                text += String('Module').padEnd(25) + String('Passed').padStart(10) + String('Total').padStart(10) + String('Status').padStart(15) + '\n';
                text += '-'.repeat(80) + '\n';

                const rows = summaryTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const module = cells[0].textContent.padEnd(25);
                        const passed = cells[1].textContent.padStart(10);
                        const total = cells[2].textContent.padStart(10);
                        const status = cells[3].textContent.padStart(15);
                        text += module + passed + total + status + '\n';
                    }
                });

                // Add footer total
                const footer = summaryTable.querySelector('tfoot tr');
                if (footer) {
                    const cells = footer.querySelectorAll('td');
                    if (cells.length >= 4) {
                        text += '-'.repeat(80) + '\n';
                        const module = cells[0].textContent.padEnd(25);
                        const passed = cells[1].textContent.padStart(10);
                        const total = cells[2].textContent.padStart(10);
                        const status = cells[3].textContent.padStart(15);
                        text += module + passed + total + status + '\n';
                    }
                }
                text += '='.repeat(80) + '\n\n';

                // Add detailed results
                const detailedHeading = Array.from(resultsDiv.querySelectorAll('h3')).find(h => h.textContent.includes('Detailed Results'));
                if (detailedHeading) {
                    text += detailedHeading.textContent + '\n';
                    text += '='.repeat(80) + '\n\n';

                    const moduleBlocks = resultsDiv.querySelectorAll('div[style*="margin: 20px 0"]');
                    moduleBlocks.forEach(block => {
                        const h4 = block.querySelector('h4');
                        if (h4) {
                            text += '\n' + h4.textContent + '\n';
                            text += '-'.repeat(h4.textContent.length) + '\n';
                        }

                        const results = block.querySelectorAll('.result');
                        results.forEach(result => {
                            const isPassing = result.classList.contains('pass');
                            const symbol = isPassing ? '‚úÖ' : '‚ùå';
                            text += symbol + ' ' + result.textContent + '\n';
                        });
                    });
                }

            } else {
                // This is single module format
                const sections = resultsDiv.querySelectorAll('.test-section');
                const results = resultsDiv.querySelectorAll('.result');
                const summary = resultsDiv.querySelector('h3:last-of-type');

                if (h3 && h3.textContent.includes('Running')) {
                    // Skip the "Running tests..." message
                }

                let currentSection = '';
                results.forEach(result => {
                    // Check if there's a section header before this result
                    const prevSibling = result.previousElementSibling;
                    if (prevSibling && prevSibling.classList.contains('test-section')) {
                        currentSection = prevSibling.textContent;
                        text += '\n' + currentSection + '\n';
                        text += '-'.repeat(currentSection.length) + '\n';
                    }

                    // Add the test result
                    const isPassing = result.classList.contains('pass');
                    const symbol = isPassing ? '‚úÖ' : '‚ùå';
                    text += symbol + ' ' + result.textContent + '\n';
                });

                text += '\n' + '='.repeat(80) + '\n';
                if (summary) {
                    text += summary.textContent + '\n';
                }
            }

            text += '='.repeat(80) + '\n';

            return text;
        }
    </script>
    </div> <!-- Close container -->
</body>
</html>
