<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#5680ff">
    <title>üß™ miniCycle Module Test Suite</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/logo/taskcycle_logo_blackandwhite_transparent.png" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --bg-gradient-start: #4c79ff;
            --bg-gradient-end: #74c0fc;
            --text-color: white;
            --card-bg: rgba(255, 255, 255, 0.15);
            --card-text: white;
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-text: #333;
            --button-bg: rgba(255, 255, 255, 0.95);
            --button-text: #4c79ff;
            --border-color: rgba(255, 255, 255, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --result-bg: rgba(255, 255, 255, 0.95);
            --result-text: #333;
            --test-section-border: rgba(255, 255, 255, 0.3);
        }

        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --text-color: #e0e0e0;
            --card-bg: rgba(30, 30, 50, 0.8);
            --card-text: #e0e0e0;
            --input-bg: #2a2a3e;
            --input-text: #e0e0e0;
            --button-bg: #3a3a5e;
            --button-text: #74c0fc;
            --border-color: rgba(116, 192, 252, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --result-bg: #2a2a3e;
            --result-text: #e0e0e0;
            --test-section-border: rgba(116, 192, 252, 0.3);
        }

        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--text-color);
            transition: background 0.3s ease, color 0.3s ease;
        }

        body {
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .module-selector {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: background 0.3s ease;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .controls-row input {
            flex: 1;
        }

        .controls-row button {
            margin: 0;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--card-text);
        }

        select, input[type="search"] {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            color: var(--input-text);
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        select {
            cursor: pointer;
            padding: 8px 12px;
        }

        select option {
            padding: 8px 12px;
            margin: 2px 0;
        }

        select option:hover {
            background: var(--button-text);
            color: white;
        }

        select:hover, input[type="search"]:hover {
            border-color: var(--button-text);
        }

        select:focus, input[type="search"]:focus {
            outline: none;
            border-color: var(--button-text);
            box-shadow: 0 0 0 3px rgba(116, 192, 252, 0.2);
        }

        input[type="search"] {
            cursor: text;
            padding: 12px 16px;
        }

        button {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px 0 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
            font-family: 'Inter', sans-serif;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color);
            opacity: 0.9;
        }

        button:active {
            transform: translateY(0);
        }

        #dark-mode-toggle {
            background: transparent;
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            font-size: 24px;
            line-height: 1;
        }

        #dark-mode-toggle:hover {
            background: var(--card-bg);
        }

        #results {
            margin-top: 30px;
        }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 25px 0 15px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 20px 0 15px;
            opacity: 0.95;
        }

        .test-section {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 25px 0 10px;
            padding: 8px 0;
            border-bottom: 2px solid var(--test-section-border);
            color: var(--text-color);
        }

        .result {
            background: var(--result-bg);
            color: var(--result-text);
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 0.95rem;
            box-shadow: 0 2px 6px var(--shadow-color);
            transition: transform 0.2s ease, background 0.3s ease;
        }

        .result:hover {
            transform: translateX(4px);
        }

        .result.hidden {
            display: none;
        }

        .pass {
            border-left: 4px solid #28a745;
        }

        body:not(.dark-mode) .pass {
            color: #155724;
        }

        body.dark-mode .pass {
            color: #4ade80;
        }

        .fail {
            border-left: 4px solid #dc3545;
        }

        body:not(.dark-mode) .fail {
            color: #721c24;
        }

        body.dark-mode .fail {
            color: #f87171;
        }

        .no-results {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: var(--text-color);
            margin: 20px 0;
        }

        /* Summary table styles for dark mode */
        table {
            color: var(--text-color);
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        body.dark-mode tbody tr {
            background-color: rgba(30, 30, 50, 0.5) !important;
        }

        body.dark-mode tbody tr:hover {
            background-color: rgba(50, 50, 70, 0.7) !important;
        }

        body.dark-mode tfoot tr {
            background-color: rgba(40, 40, 60, 0.8) !important;
        }

        body.dark-mode th {
            color: var(--text-color);
        }

        .test-element,
        #test-element,
        #test-element-2,
        .selector-test {
            display: none !important;
            visibility: hidden !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
            }

            .module-selector {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h1 style="margin: 0;">üß™ miniCycle Module Test Suite</h1>
            <button id="dark-mode-toggle" title="Toggle Dark Mode">üåô</button>
        </div>
        <p class="subtitle">Simple browser tests for miniCycle modules.</p>

    <div class="module-selector">
        <div style="margin-bottom: 15px;">
            <label for="search-modules">üîç Filter modules:</label>
            <input type="search" id="search-modules" placeholder="Type to filter module list..." style="width: 100%;">
        </div>

        <div class="controls-row">
            <div style="flex: 1;">
                <label for="module-select">Choose a module to test:</label>
                <select id="module-select" size="10" style="height: 300px;">
            <option value="">-- Select Module --</option>
            <option value="performance">‚ö° Performance Benchmarks</option>
            <option value="integration">üîó Integration Tests (E2E)</option>
            <option value="themeManager">ThemeManager</option>
            <option value="deviceDetection">DeviceDetection</option>
            <option value="cycleLoader">CycleLoader</option>
            <option value="statsPanel">StatsPanel</option>
            <option value="consoleCapture">ConsoleCapture</option>
            <option value="state">State</option>
            <option value="recurringCore">RecurringCore</option>
            <option value="recurringIntegration">RecurringIntegration</option>
            <option value="recurringPanel">RecurringPanel</option>
            <option value="globalUtils">GlobalUtils</option>
            <option value="notifications">Notifications</option>
            <option value="dragDropManager">DragDropManager</option>
            <option value="migrationManager">MigrationManager</option>
            <option value="dueDates">Due Dates</option>
            <option value="reminders">Reminders</option>
            <option value="modeManager">ModeManager</option>
            <option value="cycleSwitcher">CycleSwitcher</option>
            <option value="undoRedoManager">UndoRedoManager</option>
            <option value="gamesManager">GamesManager</option>
            <option value="onboardingManager">OnboardingManager</option>
            <option value="modalManager">ModalManager</option>
            <option value="menuManager">MenuManager</option>
            <option value="settingsManager">SettingsManager</option>
            <option value="taskCore">TaskCore</option>
            <option value="taskValidation">TaskValidation</option>
            <option value="taskUtils">TaskUtils</option>
            <option value="taskRenderer">TaskRenderer</option>
            <option value="taskEvents">TaskEvents</option>
            <option value="taskDOM">TaskDOM</option>
            <option value="deleteWhenComplete">üóëÔ∏è Delete-When-Complete</option>
            <option value="taskOptionsCustomizer">TaskOptionsCustomizer</option>
            <option value="xss-vulnerability">üîí XSS Vulnerability Tests</option>
            <option value="errorHandler">üõ°Ô∏è Error Handler Tests</option>
            <option value="testingModal">üß™ Testing Modal</option>
        </select>
            </div>
        </div>

        <button id="run-tests-btn">Run Tests</button>
        <button id="run-all-tests-btn">‚ñ∂Ô∏è Run All Tests (35 modules)</button>
        <button id="copy-results-btn" style="display: none;">üìã Copy Results</button>
    </div>

    <div id="results"></div>

    <!-- Test Elements -->
    <div id="test-element" class="test-element">Test Element</div>
    <div id="test-element-2" class="test-element">Test Element 2</div>
    <div class="selector-test test-element">Selector 1</div>
    <div class="selector-test test-element">Selector 2</div>
    <div class="selector-test test-element">Selector 3</div>

    <script type="module">
        // Cache-busting timestamp to force fresh module loads during development
        const cacheBuster = Date.now();

        // Import shared test helpers for comprehensive mock setup
        // Note: Individual test files use these helpers - they're imported here
        // for future use but the "Run All Tests" button lets each test manage its own mocks
        import {
            setupTestEnvironment,
            createMockAppState,
            createMockData,
            setupLocalStorage
        } from './testHelpers.js';

        // Import test modules with cache busting
        const { runPerformanceBenchmarks } = await import(`./performance.benchmark.js?v=${cacheBuster}`);
        const { runIntegrationTests } = await import(`./integration.tests.js?v=${cacheBuster}`);
        const { runThemeManagerTests } = await import(`./themeManager.tests.js?v=${cacheBuster}`);
        const { runDeviceDetectionTests } = await import(`./deviceDetection.tests.js?v=${cacheBuster}`);
        const { runCycleLoaderTests } = await import(`./cycleLoader.tests.js?v=${cacheBuster}`);
        const { runStatsPanelTests } = await import(`./statsPanel.tests.js?v=${cacheBuster}`);
        const { runConsoleCaptureTests } = await import(`./consoleCapture.tests.js?v=${cacheBuster}`);
        const { runStateTests } = await import(`./state.tests.js?v=${cacheBuster}`);
        const { runRecurringCoreTests } = await import(`./recurringCore.tests.js?v=${cacheBuster}`);
        const { runRecurringIntegrationTests } = await import(`./recurringIntegration.tests.js?v=${cacheBuster}`);
        const { runRecurringPanelTests } = await import(`./recurringPanel.tests.js?v=${cacheBuster}`);
        const { runGlobalUtilsTests } = await import(`./globalUtils.tests.js?v=${cacheBuster}`);
        const { runNotificationsTests } = await import(`./notifications.tests.js?v=${cacheBuster}`);
        const { runDragDropManagerTests } = await import(`./dragDropManager.tests.js?v=${cacheBuster}`);
        const { runMigrationManagerTests } = await import(`./migrationManager.tests.js?v=${cacheBuster}`);
        const { runDueDatesTests } = await import(`./dueDates.tests.js?v=${cacheBuster}`);
        const { runRemindersTests } = await import(`./reminders.tests.js?v=${cacheBuster}`);
        const { runModeManagerTests } = await import(`./modeManager.tests.js?v=${cacheBuster}`);
        const { runCycleSwitcherTests } = await import(`./cycleSwitcher.tests.js?v=${cacheBuster}`);
        const { runUndoRedoManagerTests } = await import(`./undoRedoManager.tests.js?v=${cacheBuster}`);
        const { runGamesManagerTests } = await import(`./gamesManager.tests.js?v=${cacheBuster}`);
        const { runOnboardingManagerTests } = await import(`./onboardingManager.tests.js?v=${cacheBuster}`);
        const { runModalManagerTests } = await import(`./modalManager.tests.js?v=${cacheBuster}`);
        const { runMenuManagerTests } = await import(`./menuManager.tests.js?v=${cacheBuster}`);
        const { runSettingsManagerTests } = await import(`./settingsManager.tests.js?v=${cacheBuster}`);
        const { runTaskCoreTests } = await import(`./taskCore.tests.js?v=${cacheBuster}`);
        const { runTaskValidationTests } = await import(`./taskValidation.tests.js?v=${cacheBuster}`);
        const { runTaskUtilsTests } = await import(`./taskUtils.tests.js?v=${cacheBuster}`);
        const { runTaskRendererTests } = await import(`./taskRenderer.tests.js?v=${cacheBuster}`);
        const { runTaskEventsTests } = await import(`./taskEvents.tests.js?v=${cacheBuster}`);
        const { runTaskDOMTests } = await import(`./taskDOM.tests.js?v=${cacheBuster}`);
        const { runDeleteWhenCompleteTests } = await import(`./deleteWhenComplete.tests.js?v=${cacheBuster}`);
        const { runTaskOptionsCustomizerTests } = await import(`./taskOptionsCustomizer.tests.js?v=${cacheBuster}`);
        const { runAllXSSTests } = await import(`./security/xss-vulnerability.tests.js?v=${cacheBuster}`);
        const { runErrorHandlerTests } = await import(`./errorHandler.tests.js?v=${cacheBuster}`);
        const { runTestingModalTests } = await import(`./testingModal.tests.js?v=${cacheBuster}`);

        let currentModule = null;

        const moduleSelect = document.getElementById('module-select');
        const runTestsBtn = document.getElementById('run-tests-btn');
        const runAllTestsBtn = document.getElementById('run-all-tests-btn');
        const copyResultsBtn = document.getElementById('copy-results-btn');
        const resultsDiv = document.getElementById('results');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const searchModulesInput = document.getElementById('search-modules');

        // ==========================================
        // üåô Dark Mode Toggle
        // ==========================================

        // Load saved theme preference
        const savedTheme = localStorage.getItem('testSuiteDarkMode');
        if (savedTheme === 'true') {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = '‚òÄÔ∏è';
        }

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('testSuiteDarkMode', isDark);
        });

        // ==========================================
        // üîç Module Filter Functionality
        // ==========================================

        let searchTimeout;
        searchModulesInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.toLowerCase().trim();
                filterModules(query);
            }, 200); // Debounce for better performance
        });

        function filterModules(query) {
            const options = moduleSelect.querySelectorAll('option');
            let visibleCount = 0;

            options.forEach((option, index) => {
                // Always show the first option ("-- Select Module --")
                if (index === 0) {
                    option.style.display = '';
                    return;
                }

                if (!query) {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(query)) {
                        option.style.display = '';
                        visibleCount++;
                    } else {
                        option.style.display = 'none';
                    }
                }
            });

            // Show message in select if no matches
            if (visibleCount === 0 && query) {
                // Could add a temporary option showing "No matches found"
                // but this might be confusing in a select element
            }
        }

        // ==========================================
        // üîß Shared Module Loading & Exposure Helper
        // ==========================================
        // This function is used by both individual module loading AND "Run All Tests"
        // to ensure consistent window.* exposure across both code paths.

        // Helper to ensure appInit is ready before loading modules that depend on it
        let appInitReady = false;
        async function ensureAppInitReady() {
            if (appInitReady) return;
            try {
                const { appInit } = await import('../modules/core/appInit.js');
                appInit.coreReady = true;
                if (appInit._coreResolve) {
                    appInit._coreResolve();
                }
                appInit._corePromise = Promise.resolve();
                appInitReady = true;
                console.log('‚úÖ appInit marked as ready for tests');
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not set up appInit:', e);
            }
        }

        async function loadAndExposeModule(moduleKey) {
            const cacheBuster = Date.now();

            // Ensure appInit is ready before loading any module that might import it
            await ensureAppInitReady();

            if (moduleKey === 'performance' || moduleKey === 'integration') {
                // No imports needed
                return;
            } else if (moduleKey === 'themeManager') {
                const { ThemeManager } = await import(`../modules/features/themeManager.js?v=${cacheBuster}`);
                window.ThemeManager = ThemeManager;
            } else if (moduleKey === 'deviceDetection') {
                const mod = await import(`../modules/utils/deviceDetection.js?v=${cacheBuster}`);
                window.DeviceDetectionManager = mod.DeviceDetectionManager;
                window.deviceDetectionManager = mod.deviceDetectionManager;
                window.runDeviceDetection = mod.runDeviceDetection;
                window.reportDeviceCompatibility = mod.reportDeviceCompatibility;
                window.testDeviceDetection = mod.testDeviceDetection;
            } else if (moduleKey === 'cycleLoader') {
                const mod = await import(`../modules/cycle/cycleLoader.js?v=${cacheBuster}`);
                window.loadMiniCycle = mod.loadMiniCycle;
                window.repairAndCleanTasks = mod.repairAndCleanTasks;
                window.renderTasksToDOM = mod.renderTasksToDOM;
            } else if (moduleKey === 'statsPanel') {
                const mod = await import(`../modules/features/statsPanel.js?v=${cacheBuster}`);
                window.StatsPanelManager = mod.StatsPanelManager;
            } else if (moduleKey === 'consoleCapture') {
                const mod = await import(`../modules/utils/consoleCapture.js?v=${cacheBuster}`);
                window.ConsoleCapture = mod.ConsoleCapture;
            } else if (moduleKey === 'state') {
                const mod = await import(`../modules/core/appState.js?v=${cacheBuster}`);
                window.MiniCycleState = mod.MiniCycleState;
                window.createStateManager = mod.createStateManager;
            } else if (moduleKey === 'recurringCore') {
                const mod = await import(`../modules/recurring/recurringCore.js?v=${cacheBuster}`);
                window.RecurringCore = mod.RecurringCore;
                window.setRecurringCoreDependencies = mod.setRecurringCoreDependencies;
            } else if (moduleKey === 'recurringIntegration') {
                const mod = await import(`../modules/recurring/recurringIntegration.js?v=${cacheBuster}`);
                window.initializeRecurringModules = mod.initializeRecurringModules;
                window.testRecurringIntegration = mod.testRecurringIntegration;
            } else if (moduleKey === 'recurringPanel') {
                const mod = await import(`../modules/recurring/recurringPanel.js?v=${cacheBuster}`);
                window.RecurringPanelManager = mod.RecurringPanelManager;
            } else if (moduleKey === 'globalUtils') {
                const mod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                window.GlobalUtils = mod.GlobalUtils;
                window.safeAddEventListener = mod.GlobalUtils.safeAddEventListener.bind(mod.GlobalUtils);
                window.safeGetElementById = mod.GlobalUtils.safeGetElementById.bind(mod.GlobalUtils);
                window.debounce = mod.GlobalUtils.debounce.bind(mod.GlobalUtils);
                window.throttle = mod.GlobalUtils.throttle.bind(mod.GlobalUtils);
                window.generateId = mod.GlobalUtils.generateId.bind(mod.GlobalUtils);
                window.sanitizeInput = mod.GlobalUtils.sanitizeInput.bind(mod.GlobalUtils);
                window.escapeHtml = mod.GlobalUtils.escapeHtml.bind(mod.GlobalUtils);
                window.safeLocalStorageGet = mod.GlobalUtils.safeLocalStorageGet.bind(mod.GlobalUtils);
                window.safeLocalStorageSet = mod.GlobalUtils.safeLocalStorageSet.bind(mod.GlobalUtils);
                window.safeLocalStorageRemove = mod.GlobalUtils.safeLocalStorageRemove.bind(mod.GlobalUtils);
                window.safeJSONParse = mod.GlobalUtils.safeJSONParse.bind(mod.GlobalUtils);
                window.safeJSONStringify = mod.GlobalUtils.safeJSONStringify.bind(mod.GlobalUtils);
            } else if (moduleKey === 'notifications') {
                const mod = await import(`../modules/utils/notifications.js?v=${cacheBuster}`);
                window.MiniCycleNotifications = mod.MiniCycleNotifications;
                window.EducationalTipManager = mod.EducationalTipManager;
            } else if (moduleKey === 'dragDropManager') {
                const mod = await import(`../modules/task/dragDropManager.js?v=${cacheBuster}`);
                window.DragDropManager = mod.DragDropManager;
                window.initDragDropManager = mod.initDragDropManager;
                window.enableDragAndDropOnTask = mod.enableDragAndDropOnTask;
                window.updateMoveArrowsVisibility = mod.updateMoveArrowsVisibility;
                window.toggleArrowVisibility = mod.toggleArrowVisibility;
                window.updateArrowsInDOM = mod.updateArrowsInDOM;
            } else if (moduleKey === 'migrationManager') {
                const mod = await import(`../modules/cycle/migrationManager.js?v=${cacheBuster}`);
                window.setMigrationManagerDependencies = mod.setMigrationManagerDependencies;
                window.createInitialSchema25Data = mod.createInitialSchema25Data;
                window.checkMigrationNeeded = mod.checkMigrationNeeded;
                window.simulateMigrationToSchema25 = mod.simulateMigrationToSchema25;
                window.performSchema25Migration = mod.performSchema25Migration;
                window.validateAllMiniCycleTasksLenient = mod.validateAllMiniCycleTasksLenient;
                window.fixTaskValidationIssues = mod.fixTaskValidationIssues;
                window.initializeAppWithAutoMigration = mod.initializeAppWithAutoMigration;
                window.forceAppMigration = mod.forceAppMigration;
            } else if (moduleKey === 'dueDates') {
                const mod = await import(`../modules/features/dueDates.js?v=${cacheBuster}`);
                window.MiniCycleDueDates = mod.MiniCycleDueDates;
                window.initDueDatesManager = mod.initDueDatesManager;
            } else if (moduleKey === 'reminders') {
                const mod = await import(`../modules/features/reminders.js?v=${cacheBuster}`);
                window.MiniCycleReminders = mod.MiniCycleReminders;
                window.initReminderManager = mod.initReminderManager;
            } else if (moduleKey === 'modeManager') {
                const mod = await import(`../modules/cycle/modeManager.js?v=${cacheBuster}`);
                window.ModeManager = mod.ModeManager;
                window.setModeManagerDependencies = mod.setModeManagerDependencies;
                window.initModeManager = mod.initModeManager;
            } else if (moduleKey === 'cycleSwitcher') {
                const mod = await import(`../modules/cycle/cycleSwitcher.js?v=${cacheBuster}`);
                window.CycleSwitcher = mod.CycleSwitcher;
                window.initializeCycleSwitcher = mod.initializeCycleSwitcher;
                window.switchMiniCycle = mod.switchMiniCycle;
                window.renameMiniCycle = mod.renameMiniCycle;
                window.deleteMiniCycle = mod.deleteMiniCycle;
                window.hideSwitchMiniCycleModal = mod.hideSwitchMiniCycleModal;
                window.confirmMiniCycle = mod.confirmMiniCycle;
                window.updatePreview = mod.updatePreview;
                window.loadMiniCycleList = mod.loadMiniCycleList;
                window.setupModalClickOutside = mod.setupModalClickOutside;
            } else if (moduleKey === 'undoRedoManager') {
                const mod = await import(`../modules/ui/undoRedoManager.js?v=${cacheBuster}`);
                window.setUndoRedoManagerDependencies = mod.setUndoRedoManagerDependencies;
                window.wireUndoRedoUI = mod.wireUndoRedoUI;
                window.initializeUndoRedoButtons = mod.initializeUndoRedoButtons;
                window.captureInitialSnapshot = mod.captureInitialSnapshot;
                window.setupStateBasedUndoRedo = mod.setupStateBasedUndoRedo;
                window.enableUndoSystemOnFirstInteraction = mod.enableUndoSystemOnFirstInteraction;
                window.captureStateSnapshot = mod.captureStateSnapshot;
                window.performStateBasedUndo = mod.performStateBasedUndo;
                window.performStateBasedRedo = mod.performStateBasedRedo;
                window.updateUndoRedoButtonStates = mod.updateUndoRedoButtonStates;
                window.initializeUndoSystemForApp = mod.initializeUndoSystemForApp;
            } else if (moduleKey === 'gamesManager') {
                const mod = await import(`../modules/ui/gamesManager.js?v=${cacheBuster}`);
                window.GamesManager = mod.default;
                window.gamesManager = mod.gamesManager;
                window.checkGamesUnlock = () => mod.gamesManager.checkGamesUnlock();
                window.unlockMiniGame = () => mod.gamesManager.unlockMiniGame();
            } else if (moduleKey === 'onboardingManager') {
                const mod = await import(`../modules/ui/onboardingManager.js?v=${cacheBuster}`);
                window.OnboardingManager = mod.OnboardingManager;
                window.onboardingManager = mod.onboardingManager;
                window.showOnboarding = (...args) => mod.onboardingManager.showOnboarding(...args);
            } else if (moduleKey === 'modalManager') {
                const mod = await import(`../modules/ui/modalManager.js?v=${cacheBuster}`);
                window.ModalManager = mod.ModalManager;
                window.modalManager = mod.modalManager;
                window.setModalManagerDependencies = mod.setModalManagerDependencies;
                window.closeAllModals = () => mod.modalManager.closeAllModals();
            } else if (moduleKey === 'menuManager') {
                const mod = await import(`../modules/ui/menuManager.js?v=${cacheBuster}`);
                window.MenuManager = mod.MenuManager;
                window.initMenuManager = mod.initMenuManager;
                const menuManager = mod.initMenuManager({});
                window.menuManager = menuManager;
                window.setupMainMenu = () => menuManager?.setupMainMenu();
                window.closeMainMenu = () => menuManager?.closeMainMenu();
                window.hideMainMenu = () => menuManager?.hideMainMenu();
            } else if (moduleKey === 'settingsManager') {
                const mod = await import(`../modules/ui/settingsManager.js?v=${cacheBuster}`);
                window.SettingsManager = mod.SettingsManager;
                window.initSettingsManager = mod.initSettingsManager;
                const settingsManager = mod.initSettingsManager({});
                window.settingsManager = settingsManager;
                window.setupSettingsMenu = () => settingsManager?.setupSettingsMenu();
                window.setupDownloadMiniCycle = () => settingsManager?.setupDownloadMiniCycle();
                window.setupUploadMiniCycle = () => settingsManager?.setupUploadMiniCycle();
                window.syncCurrentSettingsToStorage = () => settingsManager?.syncCurrentSettingsToStorage();
            } else if (moduleKey === 'taskCore') {
                const mod = await import(`../modules/task/taskCore.js?v=${cacheBuster}`);
                window.TaskCore = mod.TaskCore;
                window.initTaskCore = mod.initTaskCore;
                const taskCore = await mod.initTaskCore({
                    showPromptModal: (options) => {
                        console.log('[TEST] Mock prompt:', options.message);
                        if (options.callback) options.callback('Test Task');
                    },
                    showConfirmationModal: (options) => {
                        console.log('[TEST] Mock confirmation:', options.message);
                        if (options.confirmCallback) options.confirmCallback();
                    }
                });
                window.taskCore = taskCore;
                window.addTask = mod.addTask;
                window.handleTaskCompletionChange = mod.handleTaskCompletionChange;
                window.saveCurrentTaskOrder = mod.saveCurrentTaskOrder;
                window.resetTasks = mod.resetTasks;
                window.handleCompleteAllTasks = mod.handleCompleteAllTasks;
            } else if (moduleKey === 'taskValidation') {
                const mod = await import(`../modules/task/taskValidation.js?v=${cacheBuster}`);
                window.TaskValidator = mod.TaskValidator;
                window.initTaskValidator = mod.initTaskValidator;
                window.validateAndSanitizeTaskInput = mod.validateAndSanitizeTaskInput;
            } else if (moduleKey === 'taskUtils') {
                const mod = await import(`../modules/task/taskUtils.js?v=${cacheBuster}`);
                window.TaskUtils = mod.TaskUtils;
                window.buildTaskContext = mod.buildTaskContext;
                window.extractTaskDataFromDOM = mod.extractTaskDataFromDOM;
                window.loadTaskContext = mod.loadTaskContext;
                window.scrollToNewTask = mod.scrollToNewTask;
                window.handleOverdueStyling = mod.handleOverdueStyling;
                window.setupFinalTaskInteractions = mod.setupFinalTaskInteractions;
            } else if (moduleKey === 'taskRenderer') {
                const mod = await import(`../modules/task/taskRenderer.js?v=${cacheBuster}`);
                window.TaskRenderer = mod.TaskRenderer;
                window.setTaskRendererDependencies = mod.setTaskRendererDependencies;
                window.initTaskRenderer = mod.initTaskRenderer;
                window.renderTasks = mod.renderTasks;
                window.refreshUIFromState = mod.refreshUIFromState;
                window.refreshTaskListUI = mod.refreshTaskListUI;
            } else if (moduleKey === 'taskEvents') {
                const mod = await import(`../modules/task/taskEvents.js?v=${cacheBuster}`);
                window.TaskEvents = mod.TaskEvents;
                window.initTaskEvents = mod.initTaskEvents;
                window.handleTaskButtonClick = mod.handleTaskButtonClick;
                window.toggleHoverTaskOptions = mod.toggleHoverTaskOptions;
                window.revealTaskButtons = mod.revealTaskButtons;
                window.syncRecurringStateToDOM = mod.syncRecurringStateToDOM;
                window.setupTaskInteractions = mod.setupTaskInteractions;
                window.setupTaskClickInteraction = mod.setupTaskClickInteraction;
            } else if (moduleKey === 'taskDOM') {
                // Load globalUtils first (provides sanitizeInput)
                const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                window.GlobalUtils = globalMod.GlobalUtils;
                window.sanitizeInput = globalMod.GlobalUtils.sanitizeInput.bind(globalMod.GlobalUtils);
                window.generateId = globalMod.GlobalUtils.generateId.bind(globalMod.GlobalUtils);
                // Load taskUtils for TaskUtils class
                const taskUtilsMod = await import(`../modules/task/taskUtils.js?v=${cacheBuster}`);
                window.TaskUtils = taskUtilsMod.TaskUtils;
                window.buildTaskContext = taskUtilsMod.buildTaskContext;
                window.extractTaskDataFromDOM = taskUtilsMod.extractTaskDataFromDOM;
                window.loadTaskContext = taskUtilsMod.loadTaskContext;
                // Load taskDOM
                const mod = await import(`../modules/task/taskDOM.js?v=${cacheBuster}`);
                window.TaskDOMManager = mod.TaskDOMManager;
                window.initTaskDOMManager = mod.initTaskDOMManager;
                window.validateAndSanitizeTaskInput = mod.validateAndSanitizeTaskInput;
                window.createTaskDOMElements = mod.createTaskDOMElements;
                window.createTaskCheckbox = mod.createTaskCheckbox;
                window.createTaskLabel = mod.createTaskLabel;
                window.renderTasks = mod.renderTasks;
                window.refreshUIFromState = mod.refreshUIFromState;
                window.setupTaskInteractions = mod.setupTaskInteractions;
                window.revealTaskButtons = mod.revealTaskButtons;
                window.handleTaskButtonClick = mod.handleTaskButtonClick;
            } else if (moduleKey === 'taskOptionsCustomizer') {
                const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                window.GlobalUtils = globalMod.GlobalUtils;
                const mod = await import(`../modules/ui/taskOptionsCustomizer.js?v=${cacheBuster}`);
                window.TaskOptionsCustomizer = mod.TaskOptionsCustomizer;
                window.initTaskOptionsCustomizer = mod.initTaskOptionsCustomizer;
                window.taskOptionsCustomizer = mod.taskOptionsCustomizer;
            } else if (moduleKey === 'xss-vulnerability') {
                const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                window.GlobalUtils = globalMod.GlobalUtils;
            } else if (moduleKey === 'errorHandler') {
                const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                window.GlobalUtils = globalMod.GlobalUtils;
                window.safeLocalStorageGet = globalMod.GlobalUtils.safeLocalStorageGet.bind(globalMod.GlobalUtils);
                window.safeLocalStorageSet = globalMod.GlobalUtils.safeLocalStorageSet.bind(globalMod.GlobalUtils);
                window.safeLocalStorageRemove = globalMod.GlobalUtils.safeLocalStorageRemove.bind(globalMod.GlobalUtils);
                window.safeJSONParse = globalMod.GlobalUtils.safeJSONParse.bind(globalMod.GlobalUtils);
                window.safeJSONStringify = globalMod.GlobalUtils.safeJSONStringify.bind(globalMod.GlobalUtils);
                const errorMod = await import(`../modules/utils/errorHandler.js?v=${cacheBuster}`);
                window.ErrorHandler = errorMod.default;
            } else if (moduleKey === 'testingModal') {
                await import(`../modules/testing/testing-modal.js?v=${cacheBuster}`);
                await import(`../modules/storage/backupManager.js?v=${cacheBuster}`);
            }
        }

        // Load selected module
        moduleSelect.addEventListener('change', async (e) => {
            const moduleName = e.target.value;
            if (!moduleName) return;

            resultsDiv.innerHTML = '<p>Loading module...</p>';

            try {
                // Use cache buster for module imports to force fresh loads
                if (moduleName === 'performance') {
                    // Performance benchmarks don't need to import modules
                    currentModule = 'performance';
                    resultsDiv.innerHTML = '<p>‚úÖ Performance Benchmarks ready. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'integration') {
                    // Integration tests don't need to import any modules - they test the whole app
                    currentModule = 'integration';
                    resultsDiv.innerHTML = '<p>‚úÖ Integration Tests (E2E) ready. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'themeManager') {
                    const { ThemeManager } = await import(`../modules/features/themeManager.js?v=${cacheBuster}`);
                    window.ThemeManager = ThemeManager; // Expose for tests
                    currentModule = 'themeManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ThemeManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'deviceDetection') {
                    const mod = await import(`../modules/utils/deviceDetection.js?v=${cacheBuster}`);
                    window.DeviceDetectionManager = mod.DeviceDetectionManager;
                    window.deviceDetectionManager = mod.deviceDetectionManager;
                    window.runDeviceDetection = mod.runDeviceDetection;
                    window.reportDeviceCompatibility = mod.reportDeviceCompatibility;
                    window.testDeviceDetection = mod.testDeviceDetection;
                    currentModule = 'deviceDetection';
                    resultsDiv.innerHTML = '<p>‚úÖ DeviceDetection loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'cycleLoader') {
                    const mod = await import(`../modules/cycle/cycleLoader.js?v=${cacheBuster}`);
                    window.loadMiniCycle = mod.loadMiniCycle;
                    window.repairAndCleanTasks = mod.repairAndCleanTasks;
                    window.renderTasksToDOM = mod.renderTasksToDOM;
                    currentModule = 'cycleLoader';
                    resultsDiv.innerHTML = '<p>‚úÖ CycleLoader loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'statsPanel') {
                    const mod = await import(`../modules/features/statsPanel.js?v=${cacheBuster}`);
                    window.StatsPanelManager = mod.StatsPanelManager;
                    currentModule = 'statsPanel';
                    resultsDiv.innerHTML = '<p>‚úÖ StatsPanel loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'consoleCapture') {
                    const mod = await import(`../modules/utils/consoleCapture.js?v=${cacheBuster}`);
                    window.ConsoleCapture = mod.ConsoleCapture;
                    currentModule = 'consoleCapture';
                    resultsDiv.innerHTML = '<p>‚úÖ ConsoleCapture loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'state') {
                    const mod = await import(`../modules/core/appState.js?v=${cacheBuster}`);
                    window.MiniCycleState = mod.MiniCycleState;
                    window.createStateManager = mod.createStateManager;
                    currentModule = 'state';
                    resultsDiv.innerHTML = '<p>‚úÖ State loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringCore') {
                    const mod = await import(`../modules/recurring/recurringCore.js?v=${cacheBuster}`);
                    window.RecurringCore = mod.RecurringCore;
                    window.setRecurringCoreDependencies = mod.setRecurringCoreDependencies;
                    currentModule = 'recurringCore';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringCore loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringIntegration') {
                    const mod = await import(`../modules/recurring/recurringIntegration.js?v=${cacheBuster}`);
                    window.initializeRecurringModules = mod.initializeRecurringModules;
                    window.testRecurringIntegration = mod.testRecurringIntegration;
                    currentModule = 'recurringIntegration';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringIntegration loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'recurringPanel') {
                    const mod = await import(`../modules/recurring/recurringPanel.js?v=${cacheBuster}`);
                    window.RecurringPanelManager = mod.RecurringPanelManager;
                    currentModule = 'recurringPanel';
                    resultsDiv.innerHTML = '<p>‚úÖ RecurringPanel loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'globalUtils') {
                    const mod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = mod.GlobalUtils; // Expose class for tests
                    // Expose common utility functions on window (like main app does)
                    window.safeAddEventListener = mod.GlobalUtils.safeAddEventListener.bind(mod.GlobalUtils);
                    window.safeGetElementById = mod.GlobalUtils.safeGetElementById.bind(mod.GlobalUtils);
                    window.debounce = mod.GlobalUtils.debounce.bind(mod.GlobalUtils);
                    window.throttle = mod.GlobalUtils.throttle.bind(mod.GlobalUtils);
                    window.generateId = mod.GlobalUtils.generateId.bind(mod.GlobalUtils);
                    window.sanitizeInput = mod.GlobalUtils.sanitizeInput.bind(mod.GlobalUtils);
                    window.escapeHtml = mod.GlobalUtils.escapeHtml.bind(mod.GlobalUtils);
                    window.safeLocalStorageGet = mod.GlobalUtils.safeLocalStorageGet.bind(mod.GlobalUtils);
                    window.safeLocalStorageSet = mod.GlobalUtils.safeLocalStorageSet.bind(mod.GlobalUtils);
                    window.safeLocalStorageRemove = mod.GlobalUtils.safeLocalStorageRemove.bind(mod.GlobalUtils);
                    window.safeJSONParse = mod.GlobalUtils.safeJSONParse.bind(mod.GlobalUtils);
                    window.safeJSONStringify = mod.GlobalUtils.safeJSONStringify.bind(mod.GlobalUtils);
                    currentModule = 'globalUtils';
                    resultsDiv.innerHTML = '<p>‚úÖ GlobalUtils loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'notifications') {
                    const mod = await import(`../modules/utils/notifications.js?v=${cacheBuster}`);
                    window.MiniCycleNotifications = mod.MiniCycleNotifications;
                    window.EducationalTipManager = mod.EducationalTipManager;
                    currentModule = 'notifications';
                    resultsDiv.innerHTML = '<p>‚úÖ Notifications loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'dragDropManager') {
                    const mod = await import(`../modules/task/dragDropManager.js?v=${cacheBuster}`);
                    window.DragDropManager = mod.DragDropManager;
                    window.initDragDropManager = mod.initDragDropManager;
                    window.enableDragAndDropOnTask = mod.enableDragAndDropOnTask;
                    window.updateMoveArrowsVisibility = mod.updateMoveArrowsVisibility;
                    window.toggleArrowVisibility = mod.toggleArrowVisibility;
                    window.updateArrowsInDOM = mod.updateArrowsInDOM;
                    currentModule = 'dragDropManager';
                    resultsDiv.innerHTML = '<p>‚úÖ DragDropManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'migrationManager') {
                    const mod = await import(`../modules/cycle/migrationManager.js?v=${cacheBuster}`);
                    window.setMigrationManagerDependencies = mod.setMigrationManagerDependencies;
                    window.createInitialSchema25Data = mod.createInitialSchema25Data;
                    window.checkMigrationNeeded = mod.checkMigrationNeeded;
                    window.simulateMigrationToSchema25 = mod.simulateMigrationToSchema25;
                    window.performSchema25Migration = mod.performSchema25Migration;
                    window.validateAllMiniCycleTasksLenient = mod.validateAllMiniCycleTasksLenient;
                    window.fixTaskValidationIssues = mod.fixTaskValidationIssues;
                    window.initializeAppWithAutoMigration = mod.initializeAppWithAutoMigration;
                    window.forceAppMigration = mod.forceAppMigration;
                    currentModule = 'migrationManager';
                    resultsDiv.innerHTML = '<p>‚úÖ MigrationManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'dueDates') {
                    const mod = await import(`../modules/features/dueDates.js?v=${cacheBuster}`);
                    window.MiniCycleDueDates = mod.MiniCycleDueDates;
                    window.initDueDatesManager = mod.initDueDatesManager;
                    currentModule = 'dueDates';
                    resultsDiv.innerHTML = '<p>‚úÖ Due Dates loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'reminders') {
                    const mod = await import(`../modules/features/reminders.js?v=${cacheBuster}`);
                    window.MiniCycleReminders = mod.MiniCycleReminders;
                    window.initReminderManager = mod.initReminderManager;
                    currentModule = 'reminders';
                    resultsDiv.innerHTML = '<p>‚úÖ Reminders loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'modeManager') {
                    const mod = await import(`../modules/cycle/modeManager.js?v=${cacheBuster}`);
                    window.ModeManager = mod.ModeManager;
                    window.setModeManagerDependencies = mod.setModeManagerDependencies;
                    window.initModeManager = mod.initModeManager;
                    currentModule = 'modeManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ModeManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'cycleSwitcher') {
                    const mod = await import(`../modules/cycle/cycleSwitcher.js?v=${cacheBuster}`);
                    window.CycleSwitcher = mod.CycleSwitcher;
                    window.initializeCycleSwitcher = mod.initializeCycleSwitcher;
                    // Expose wrapper functions as globals
                    window.switchMiniCycle = mod.switchMiniCycle;
                    window.renameMiniCycle = mod.renameMiniCycle;
                    window.deleteMiniCycle = mod.deleteMiniCycle;
                    window.hideSwitchMiniCycleModal = mod.hideSwitchMiniCycleModal;
                    window.confirmMiniCycle = mod.confirmMiniCycle;
                    window.updatePreview = mod.updatePreview;
                    window.loadMiniCycleList = mod.loadMiniCycleList;
                    window.setupModalClickOutside = mod.setupModalClickOutside;
                    currentModule = 'cycleSwitcher';
                    resultsDiv.innerHTML = '<p>‚úÖ CycleSwitcher loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'undoRedoManager') {
                    const mod = await import(`../modules/ui/undoRedoManager.js?v=${cacheBuster}`);
                    window.setUndoRedoManagerDependencies = mod.setUndoRedoManagerDependencies;
                    window.wireUndoRedoUI = mod.wireUndoRedoUI;
                    window.initializeUndoRedoButtons = mod.initializeUndoRedoButtons;
                    window.captureInitialSnapshot = mod.captureInitialSnapshot;
                    window.setupStateBasedUndoRedo = mod.setupStateBasedUndoRedo;
                    window.enableUndoSystemOnFirstInteraction = mod.enableUndoSystemOnFirstInteraction;
                    window.captureStateSnapshot = mod.captureStateSnapshot;
                    window.performStateBasedUndo = mod.performStateBasedUndo;
                    window.performStateBasedRedo = mod.performStateBasedRedo;
                    window.updateUndoRedoButtonStates = mod.updateUndoRedoButtonStates;
                    window.initializeUndoSystemForApp = mod.initializeUndoSystemForApp;
                    currentModule = 'undoRedoManager';
                    resultsDiv.innerHTML = '<p>‚úÖ UndoRedoManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'gamesManager') {
                    const mod = await import(`../modules/ui/gamesManager.js?v=${cacheBuster}`);
                    window.GamesManager = mod.default;
                    window.gamesManager = mod.gamesManager;
                    // Expose instance methods as globals
                    window.checkGamesUnlock = () => mod.gamesManager.checkGamesUnlock();
                    window.unlockMiniGame = () => mod.gamesManager.unlockMiniGame();
                    currentModule = 'gamesManager';
                    resultsDiv.innerHTML = '<p>‚úÖ GamesManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'onboardingManager') {
                    const mod = await import(`../modules/ui/onboardingManager.js?v=${cacheBuster}`);
                    window.OnboardingManager = mod.OnboardingManager;
                    window.onboardingManager = mod.onboardingManager;
                    // Expose instance methods as globals
                    window.showOnboarding = (...args) => mod.onboardingManager.showOnboarding(...args);
                    currentModule = 'onboardingManager';
                    resultsDiv.innerHTML = '<p>‚úÖ OnboardingManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'modalManager') {
                    const mod = await import(`../modules/ui/modalManager.js?v=${cacheBuster}`);
                    window.ModalManager = mod.ModalManager;
                    window.modalManager = mod.modalManager;
                    window.setModalManagerDependencies = mod.setModalManagerDependencies;
                    // Expose instance methods as globals
                    window.closeAllModals = () => mod.modalManager.closeAllModals();
                    currentModule = 'modalManager';
                    resultsDiv.innerHTML = '<p>‚úÖ ModalManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'menuManager') {
                    const mod = await import(`../modules/ui/menuManager.js?v=${cacheBuster}`);
                    window.MenuManager = mod.MenuManager;
                    window.initMenuManager = mod.initMenuManager;
                    // Initialize and expose instance methods as globals
                    const menuManager = mod.initMenuManager({});
                    window.menuManager = menuManager;
                    window.setupMainMenu = () => menuManager?.setupMainMenu();
                    window.closeMainMenu = () => menuManager?.closeMainMenu();
                    window.hideMainMenu = () => menuManager?.hideMainMenu();
                    currentModule = 'menuManager';
                    resultsDiv.innerHTML = '<p>‚úÖ MenuManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'settingsManager') {
                    const mod = await import(`../modules/ui/settingsManager.js?v=${cacheBuster}`);
                    window.SettingsManager = mod.SettingsManager;
                    window.initSettingsManager = mod.initSettingsManager;
                    // Initialize and expose instance methods as globals
                    const settingsManager = mod.initSettingsManager({});
                    window.settingsManager = settingsManager;
                    window.setupSettingsMenu = () => settingsManager?.setupSettingsMenu();
                    window.setupDownloadMiniCycle = () => settingsManager?.setupDownloadMiniCycle();
                    window.setupUploadMiniCycle = () => settingsManager?.setupUploadMiniCycle();
                    window.syncCurrentSettingsToStorage = () => settingsManager?.syncCurrentSettingsToStorage();
                    currentModule = 'settingsManager';
                    resultsDiv.innerHTML = '<p>‚úÖ SettingsManager loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskCore') {
                    const mod = await import(`../modules/task/taskCore.js?v=${cacheBuster}`);
                    window.TaskCore = mod.TaskCore;
                    window.initTaskCore = mod.initTaskCore;
                    // Initialize with test-friendly mocks to avoid prompts
                    const taskCore = await mod.initTaskCore({
                        showPromptModal: (options) => {
                            console.log('[TEST] Mock prompt:', options.message);
                            // Auto-provide a test value to avoid blocking tests
                            if (options.callback) options.callback('Test Task');
                        },
                        showConfirmationModal: (options) => {
                            console.log('[TEST] Mock confirmation:', options.message);
                            // Auto-confirm to avoid blocking tests
                            if (options.confirmCallback) options.confirmCallback();
                        }
                    });
                    // Expose instance and wrapper functions as globals
                    window.taskCore = taskCore;
                    window.addTask = mod.addTask;
                    window.handleTaskCompletionChange = mod.handleTaskCompletionChange;
                    window.saveCurrentTaskOrder = mod.saveCurrentTaskOrder;
                    window.resetTasks = mod.resetTasks;
                    window.handleCompleteAllTasks = mod.handleCompleteAllTasks;
                    currentModule = 'taskCore';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskCore loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskValidation') {
                    const mod = await import(`../modules/task/taskValidation.js?v=${cacheBuster}`);
                    window.TaskValidator = mod.TaskValidator;
                    window.initTaskValidator = mod.initTaskValidator;
                    window.validateAndSanitizeTaskInput = mod.validateAndSanitizeTaskInput;
                    currentModule = 'taskValidation';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskValidation loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskUtils') {
                    const mod = await import(`../modules/task/taskUtils.js?v=${cacheBuster}`);
                    window.TaskUtils = mod.TaskUtils;
                    // Expose wrapper functions as globals
                    window.buildTaskContext = mod.buildTaskContext;
                    window.extractTaskDataFromDOM = mod.extractTaskDataFromDOM;
                    window.loadTaskContext = mod.loadTaskContext;
                    window.scrollToNewTask = mod.scrollToNewTask;
                    window.handleOverdueStyling = mod.handleOverdueStyling;
                    window.setupFinalTaskInteractions = mod.setupFinalTaskInteractions;
                    currentModule = 'taskUtils';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskUtils loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskRenderer') {
                    const mod = await import(`../modules/task/taskRenderer.js?v=${cacheBuster}`);
                    window.TaskRenderer = mod.TaskRenderer;
                    window.setTaskRendererDependencies = mod.setTaskRendererDependencies;
                    window.initTaskRenderer = mod.initTaskRenderer;
                    // Expose wrapper functions as globals
                    window.renderTasks = mod.renderTasks;
                    window.refreshUIFromState = mod.refreshUIFromState;
                    window.refreshTaskListUI = mod.refreshTaskListUI;
                    currentModule = 'taskRenderer';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskRenderer loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskEvents') {
                    const mod = await import(`../modules/task/taskEvents.js?v=${cacheBuster}`);
                    window.TaskEvents = mod.TaskEvents;
                    window.initTaskEvents = mod.initTaskEvents;
                    // Expose wrapper functions as globals
                    window.handleTaskButtonClick = mod.handleTaskButtonClick;
                    window.toggleHoverTaskOptions = mod.toggleHoverTaskOptions;
                    window.revealTaskButtons = mod.revealTaskButtons;
                    window.syncRecurringStateToDOM = mod.syncRecurringStateToDOM;
                    window.setupTaskInteractions = mod.setupTaskInteractions;
                    window.setupTaskClickInteraction = mod.setupTaskClickInteraction;
                    currentModule = 'taskEvents';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskEvents loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskDOM') {
                    // Load globalUtils first (provides sanitizeInput)
                    const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = globalMod.GlobalUtils;
                    window.sanitizeInput = globalMod.GlobalUtils.sanitizeInput.bind(globalMod.GlobalUtils);
                    window.generateId = globalMod.GlobalUtils.generateId.bind(globalMod.GlobalUtils);
                    // Load taskUtils for TaskUtils class
                    const taskUtilsMod = await import(`../modules/task/taskUtils.js?v=${cacheBuster}`);
                    window.TaskUtils = taskUtilsMod.TaskUtils;
                    window.buildTaskContext = taskUtilsMod.buildTaskContext;
                    window.extractTaskDataFromDOM = taskUtilsMod.extractTaskDataFromDOM;
                    window.loadTaskContext = taskUtilsMod.loadTaskContext;
                    // Load taskDOM
                    const mod = await import(`../modules/task/taskDOM.js?v=${cacheBuster}`);
                    window.TaskDOMManager = mod.TaskDOMManager;
                    window.initTaskDOMManager = mod.initTaskDOMManager;
                    window.validateAndSanitizeTaskInput = mod.validateAndSanitizeTaskInput;
                    window.createTaskDOMElements = mod.createTaskDOMElements;
                    window.createTaskCheckbox = mod.createTaskCheckbox;
                    window.createTaskLabel = mod.createTaskLabel;
                    window.renderTasks = mod.renderTasks;
                    window.refreshUIFromState = mod.refreshUIFromState;
                    window.setupTaskInteractions = mod.setupTaskInteractions;
                    window.revealTaskButtons = mod.revealTaskButtons;
                    window.handleTaskButtonClick = mod.handleTaskButtonClick;
                    currentModule = 'taskDOM';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskDOM loaded (with globalUtils and taskUtils). Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'deleteWhenComplete') {
                    // Load required modules for delete-when-complete tests
                    const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = globalMod.GlobalUtils;
                    await import(`../modules/core/constants.js?v=${cacheBuster}`);
                    currentModule = 'deleteWhenComplete';
                    resultsDiv.innerHTML = '<p>‚úÖ Delete-When-Complete tests loaded (with globalUtils and constants). Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'taskOptionsCustomizer') {
                    const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = globalMod.GlobalUtils;
                    const mod = await import(`../modules/ui/taskOptionsCustomizer.js?v=${cacheBuster}`);
                    window.TaskOptionsCustomizer = mod.TaskOptionsCustomizer;
                    window.initTaskOptionsCustomizer = mod.initTaskOptionsCustomizer;
                    window.taskOptionsCustomizer = mod.taskOptionsCustomizer;
                    currentModule = 'taskOptionsCustomizer';
                    resultsDiv.innerHTML = '<p>‚úÖ TaskOptionsCustomizer loaded. Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'xss-vulnerability') {
                    // Load globalUtils first (provides window.sanitizeInput and escapeHtml)
                    const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = globalMod.GlobalUtils;
                    currentModule = 'xss-vulnerability';
                    resultsDiv.innerHTML = '<p>‚úÖ XSS Vulnerability Tests ready (with globalUtils). Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'errorHandler') {
                    // Load globalUtils and errorHandler
                    const globalMod = await import(`../modules/utils/globalUtils.js?v=${cacheBuster}`);
                    window.GlobalUtils = globalMod.GlobalUtils;
                    // Expose safe functions as globals (like main app does)
                    window.safeLocalStorageGet = globalMod.GlobalUtils.safeLocalStorageGet.bind(globalMod.GlobalUtils);
                    window.safeLocalStorageSet = globalMod.GlobalUtils.safeLocalStorageSet.bind(globalMod.GlobalUtils);
                    window.safeLocalStorageRemove = globalMod.GlobalUtils.safeLocalStorageRemove.bind(globalMod.GlobalUtils);
                    window.safeJSONParse = globalMod.GlobalUtils.safeJSONParse.bind(globalMod.GlobalUtils);
                    window.safeJSONStringify = globalMod.GlobalUtils.safeJSONStringify.bind(globalMod.GlobalUtils);
                    // Load errorHandler and expose
                    const errorMod = await import(`../modules/utils/errorHandler.js?v=${cacheBuster}`);
                    window.ErrorHandler = errorMod.default;
                    currentModule = 'errorHandler';
                    resultsDiv.innerHTML = '<p>‚úÖ Error Handler Tests ready (with globalUtils and errorHandler). Click "Run Tests" to begin.</p>';
                } else if (moduleName === 'testingModal') {
                    // Load testing modal dependencies
                    await import(`../modules/testing/testing-modal.js?v=${cacheBuster}`);
                    await import(`../modules/storage/backupManager.js?v=${cacheBuster}`);
                    currentModule = 'testingModal';
                    resultsDiv.innerHTML = '<p>‚úÖ Testing Modal Tests ready (with testing-modal and backupManager). Click "Run Tests" to begin.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result fail">‚ùå Failed to load module: ${error.message}</div>`;
            }
        });

        // Run tests (async to handle async test functions)
        runTestsBtn.addEventListener('click', async () => {
            if (!currentModule) {
                resultsDiv.innerHTML = '<div class="result fail">‚ùå Please select a module first</div>';
                return;
            }

            if (currentModule === 'performance') {
                await runPerformanceBenchmarks(resultsDiv);
            } else if (currentModule === 'integration') {
                await runIntegrationTests(resultsDiv);
            } else if (currentModule === 'themeManager') {
                await runThemeManagerTests(resultsDiv);
            } else if (currentModule === 'deviceDetection') {
                await runDeviceDetectionTests(resultsDiv);
            } else if (currentModule === 'cycleLoader') {
                await runCycleLoaderTests(resultsDiv);
            } else if (currentModule === 'statsPanel') {
                await runStatsPanelTests(resultsDiv);
            } else if (currentModule === 'consoleCapture') {
                await runConsoleCaptureTests(resultsDiv);
            } else if (currentModule === 'state') {
                await runStateTests(resultsDiv);
            } else if (currentModule === 'recurringCore') {
                await runRecurringCoreTests(resultsDiv);
            } else if (currentModule === 'recurringIntegration') {
                await runRecurringIntegrationTests(resultsDiv);
            } else if (currentModule === 'recurringPanel') {
                await runRecurringPanelTests(resultsDiv);
            } else if (currentModule === 'globalUtils') {
                await runGlobalUtilsTests(resultsDiv);
            } else if (currentModule === 'notifications') {
                await runNotificationsTests(resultsDiv);
            } else if (currentModule === 'dragDropManager') {
                await runDragDropManagerTests(resultsDiv);
            } else if (currentModule === 'migrationManager') {
                await runMigrationManagerTests(resultsDiv);
            } else if (currentModule === 'dueDates') {
                await runDueDatesTests(resultsDiv);
            } else if (currentModule === 'reminders') {
                await runRemindersTests(resultsDiv);
            } else if (currentModule === 'modeManager') {
                await runModeManagerTests(resultsDiv);
            } else if (currentModule === 'cycleSwitcher') {
                await runCycleSwitcherTests(resultsDiv);
            } else if (currentModule === 'undoRedoManager') {
                await runUndoRedoManagerTests(resultsDiv);
            } else if (currentModule === 'gamesManager') {
                await runGamesManagerTests(resultsDiv);
            } else if (currentModule === 'onboardingManager') {
                await runOnboardingManagerTests(resultsDiv);
            } else if (currentModule === 'modalManager') {
                await runModalManagerTests(resultsDiv);
            } else if (currentModule === 'menuManager') {
                await runMenuManagerTests(resultsDiv);
            } else if (currentModule === 'settingsManager') {
                await runSettingsManagerTests(resultsDiv);
            } else if (currentModule === 'taskCore') {
                await runTaskCoreTests(resultsDiv);
            } else if (currentModule === 'taskValidation') {
                await runTaskValidationTests(resultsDiv);
            } else if (currentModule === 'taskUtils') {
                await runTaskUtilsTests(resultsDiv);
            } else if (currentModule === 'taskRenderer') {
                await runTaskRendererTests(resultsDiv);
            } else if (currentModule === 'taskEvents') {
                await runTaskEventsTests(resultsDiv);
            } else if (currentModule === 'taskDOM') {
                await runTaskDOMTests(resultsDiv);
            } else if (currentModule === 'deleteWhenComplete') {
                await runDeleteWhenCompleteTests(resultsDiv);
            } else if (currentModule === 'taskOptionsCustomizer') {
                await runTaskOptionsCustomizerTests(resultsDiv);
            } else if (currentModule === 'xss-vulnerability') {
                await runAllXSSTests(resultsDiv);
            } else if (currentModule === 'errorHandler') {
                await runErrorHandlerTests(resultsDiv);
            } else if (currentModule === 'testingModal') {
                await runTestingModalTests(resultsDiv);
            }

            // Show copy button after tests run
            copyResultsBtn.style.display = 'inline-block';
        });

        // Copy results to clipboard with iOS/iPad fallback
        copyResultsBtn.addEventListener('click', async () => {
            try {
                const textResults = convertResultsToText();

                // Try modern Clipboard API first (works on localhost)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(textResults);
                        showCopySuccess();
                        return;
                    } catch (clipboardError) {
                        console.log('Clipboard API blocked, using fallback...');
                    }
                }

                // Fallback for iPad/iPhone and non-HTTPS contexts
                const textarea = document.createElement('textarea');
                textarea.value = textResults;
                textarea.style.position = 'fixed';
                textarea.style.top = '0';
                textarea.style.left = '0';
                textarea.style.width = '2em';
                textarea.style.height = '2em';
                textarea.style.padding = '0';
                textarea.style.border = 'none';
                textarea.style.outline = 'none';
                textarea.style.boxShadow = 'none';
                textarea.style.background = 'transparent';
                document.body.appendChild(textarea);

                // Select the text
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, textarea.value.length);

                // Copy using execCommand (works on iOS Safari)
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }

            } catch (error) {
                console.error('Failed to copy:', error);
                alert('Failed to copy results to clipboard. Try manually selecting the results.');
            }
        });

        function showCopySuccess() {
            const originalText = copyResultsBtn.textContent;
            copyResultsBtn.textContent = '‚úÖ Copied!';
            setTimeout(() => {
                copyResultsBtn.textContent = originalText;
            }, 2000);
        }

        // Run all tests
        runAllTestsBtn.addEventListener('click', async () => {
            const startTime = performance.now();

            resultsDiv.innerHTML = '<h2>üß™ Running All Tests...</h2><p>This may take a few moments...</p>';
            copyResultsBtn.style.display = 'none';

            // üõ°Ô∏è PREVENT PAGE RELOADS during tests
            const originalBeforeUnload = window.onbeforeunload;

            // Set a flag that modules can check to avoid reload during tests
            window.__TEST_MODE_NO_RELOAD__ = true;

            // Monkey-patch setTimeout to intercept delayed reloads
            const originalSetTimeout = window.setTimeout;
            window.setTimeout = function(fn, delay, ...args) {
                // Check if the function contains reload code
                const fnStr = fn.toString();
                if (fnStr.includes('location.reload') || fnStr.includes('window.location.reload')) {
                    console.warn('‚ö†Ô∏è Blocked setTimeout with location.reload() during tests');
                    return -1; // Return fake timer ID
                }
                return originalSetTimeout(fn, delay, ...args);
            };

            // Block beforeunload
            window.onbeforeunload = (e) => {
                console.warn('‚ö†Ô∏è Blocked beforeunload during tests');
                e.preventDefault();
                e.returnValue = '';
                return '';
            };

            // üîí SAVE REAL APP DATA ONCE before all tests run
            const savedRealData = {};
            const protectedKeys = ['miniCycleData', 'miniCycleForceFullVersion'];
            protectedKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    savedRealData[key] = value;
                }
            });
            console.log('üîí Saved original localStorage before running all tests');

            // Define all modules and their test functions
            const allModules = [
                { name: 'üîó Integration (E2E)', key: 'integration', runFn: runIntegrationTests, importPath: null },
                { name: 'ThemeManager', key: 'themeManager', runFn: runThemeManagerTests, importPath: '../modules/features/themeManager.js' },
                { name: 'DeviceDetection', key: 'deviceDetection', runFn: runDeviceDetectionTests, importPath: '../modules/utils/deviceDetection.js' },
                { name: 'CycleLoader', key: 'cycleLoader', runFn: runCycleLoaderTests, importPath: '../modules/cycle/cycleLoader.js' },
                { name: 'StatsPanel', key: 'statsPanel', runFn: runStatsPanelTests, importPath: '../modules/features/statsPanel.js' },
                { name: 'ConsoleCapture', key: 'consoleCapture', runFn: runConsoleCaptureTests, importPath: '../modules/utils/consoleCapture.js' },
                { name: 'State', key: 'state', runFn: runStateTests, importPath: '../modules/core/appState.js' },
                { name: 'RecurringCore', key: 'recurringCore', runFn: runRecurringCoreTests, importPath: '../modules/recurring/recurringCore.js' },
                { name: 'RecurringIntegration', key: 'recurringIntegration', runFn: runRecurringIntegrationTests, importPath: '../modules/recurring/recurringIntegration.js' },
                { name: 'RecurringPanel', key: 'recurringPanel', runFn: runRecurringPanelTests, importPath: '../modules/recurring/recurringPanel.js' },
                { name: 'GlobalUtils', key: 'globalUtils', runFn: runGlobalUtilsTests, importPath: '../modules/utils/globalUtils.js' },
                { name: 'Notifications', key: 'notifications', runFn: runNotificationsTests, importPath: '../modules/utils/notifications.js' },
                { name: 'DragDropManager', key: 'dragDropManager', runFn: runDragDropManagerTests, importPath: '../modules/task/dragDropManager.js' },
                { name: 'MigrationManager', key: 'migrationManager', runFn: runMigrationManagerTests, importPath: '../modules/cycle/migrationManager.js' },
                { name: 'DueDates', key: 'dueDates', runFn: runDueDatesTests, importPath: '../modules/features/dueDates.js' },
                { name: 'Reminders', key: 'reminders', runFn: runRemindersTests, importPath: '../modules/features/reminders.js' },
                { name: 'MenuManager', key: 'menuManager', runFn: runMenuManagerTests, importPath: '../modules/ui/menuManager.js' },
                { name: 'SettingsManager', key: 'settingsManager', runFn: runSettingsManagerTests, importPath: '../modules/ui/settingsManager.js' },
                { name: 'ModeManager', key: 'modeManager', runFn: runModeManagerTests, importPath: '../modules/cycle/modeManager.js' },
                { name: 'CycleSwitcher', key: 'cycleSwitcher', runFn: runCycleSwitcherTests, importPath: '../modules/cycle/cycleSwitcher.js' },
                { name: 'UndoRedoManager', key: 'undoRedoManager', runFn: runUndoRedoManagerTests, importPath: '../modules/ui/undoRedoManager.js' },
                { name: 'GamesManager', key: 'gamesManager', runFn: runGamesManagerTests, importPath: '../modules/ui/gamesManager.js' },
                { name: 'OnboardingManager', key: 'onboardingManager', runFn: runOnboardingManagerTests, importPath: '../modules/ui/onboardingManager.js' },
                { name: 'ModalManager', key: 'modalManager', runFn: runModalManagerTests, importPath: '../modules/ui/modalManager.js' },
                { name: 'TaskCore', key: 'taskCore', runFn: runTaskCoreTests, importPath: '../modules/task/taskCore.js' },
                { name: 'TaskValidation', key: 'taskValidation', runFn: runTaskValidationTests, importPath: '../modules/task/taskValidation.js' },
                { name: 'TaskUtils', key: 'taskUtils', runFn: runTaskUtilsTests, importPath: '../modules/task/taskUtils.js' },
                { name: 'TaskRenderer', key: 'taskRenderer', runFn: runTaskRendererTests, importPath: '../modules/task/taskRenderer.js' },
                { name: 'TaskEvents', key: 'taskEvents', runFn: runTaskEventsTests, importPath: '../modules/task/taskEvents.js' },
                { name: 'TaskDOM', key: 'taskDOM', runFn: runTaskDOMTests, importPath: '../modules/task/taskDOM.js' },
                { name: 'TaskOptionsCustomizer', key: 'taskOptionsCustomizer', runFn: runTaskOptionsCustomizerTests, importPath: '../modules/ui/taskOptionsCustomizer.js' },
                { name: 'XSS Vulnerability', key: 'xss-vulnerability', runFn: runAllXSSTests, importPath: null },
                { name: 'Error Handler', key: 'errorHandler', runFn: runErrorHandlerTests, importPath: '../modules/utils/errorHandler.js' },
                { name: 'Testing Modal', key: 'testingModal', runFn: runTestingModalTests, importPath: '../modules/testing/testing-modal.js', secondaryImport: '../modules/storage/backupManager.js' }
            ];

            let allResults = [];
            let totalPassed = 0;
            let totalTests = 0;

            try {
                // Run each module's tests
                for (const module of allModules) {
                    try {
                        // Load and expose the module using shared helper
                        // This ensures consistent window.* exposure for all modules
                        await loadAndExposeModule(module.key);

                    // Create a temporary div for results
                    const tempDiv = document.createElement('div');

                    // Run the tests (pass isPartOfSuite=true for tests that manage localStorage)
                    let result;
                    if (module.key === 'integration') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'state') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'cycleLoader') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'deviceDetection') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else if (module.key === 'migrationManager') {
                        result = await module.runFn(tempDiv, true); // isPartOfSuite = true
                    } else {
                        result = await module.runFn(tempDiv);
                    }

                    // Store results
                    allResults.push({
                        name: module.name,
                        passed: result?.passed || 0,
                        total: result?.total || 0,
                        html: tempDiv.innerHTML
                    });

                    totalPassed += (result?.passed || 0);
                    totalTests += (result?.total || 0);

                } catch (error) {
                    allResults.push({
                        name: module.name,
                        passed: 0,
                        total: 0,
                        error: error.message,
                        html: `<div class="result fail">‚ùå Failed to run tests: ${error.message}</div>`
                    });
                    }
                }

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // Display aggregated results
                let output = '<h2>üß™ All Module Test Results</h2>';
                output += `<h3>Completed in ${duration}s</h3>`;

            // Summary table
            output += '<div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 8px; margin: 20px 0; color: #333;">';
            output += '<h3 style="color: #333; margin-top: 0;">üìä Summary</h3>';
            output += '<table style="width: 100%; border-collapse: collapse;">';
            output += '<thead><tr style="border-bottom: 2px solid #ddd;"><th style="text-align: left; padding: 8px;">Module</th><th style="text-align: right; padding: 8px;">Passed</th><th style="text-align: right; padding: 8px;">Total</th><th style="text-align: right; padding: 8px;">Status</th></tr></thead>';
            output += '<tbody>';

            for (const result of allResults) {
                const passRate = result.total > 0 ? (result.passed / result.total * 100).toFixed(0) : 0;
                const statusEmoji = result.passed === result.total ? '‚úÖ' : '‚ùå';
                const rowColor = result.passed === result.total ? '#d4edda' : '#f8d7da';

                output += `<tr style="border-bottom: 1px solid #eee; background: ${rowColor};">`;
                output += `<td style="padding: 8px; font-weight: 600;">${result.name}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${result.passed}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${result.total}</td>`;
                output += `<td style="text-align: right; padding: 8px;">${statusEmoji} ${passRate}%</td>`;
                output += '</tr>';
            }

            output += '</tbody>';
            output += '<tfoot><tr style="border-top: 2px solid #333; font-weight: bold; background: #e9ecef;"><td style="padding: 8px;">TOTAL</td><td style="text-align: right; padding: 8px;">' + totalPassed + '</td><td style="text-align: right; padding: 8px;">' + totalTests + '</td><td style="text-align: right; padding: 8px;">' + (totalPassed === totalTests ? '‚úÖ' : '‚ùå') + ' ' + (totalTests > 0 ? (totalPassed / totalTests * 100).toFixed(0) : 0) + '%</td></tr></tfoot>';
            output += '</table>';
            output += '</div>';

            // Detailed results for each module
            output += '<h3 style="margin-top: 30px;">üìã Detailed Results</h3>';
            for (const result of allResults) {
                output += '<div style="margin: 20px 0; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">';
                output += `<h4 style="margin-top: 0;">${result.name} (${result.passed}/${result.total})</h4>`;
                output += result.html;
                output += '</div>';
            }

                resultsDiv.innerHTML = output;
                copyResultsBtn.style.display = 'inline-block';

                // ‚è±Ô∏è WAIT for any debounced saves to complete (700ms safety margin)
                await new Promise(resolve => setTimeout(resolve, 700));

            } catch (error) {
                console.error('‚ùå Fatal error during test execution:', error);
                resultsDiv.innerHTML += `<div class="result fail">‚ùå Fatal error: ${error.message}</div>`;
            } finally {
                // üîí RESTORE REAL APP DATA after all tests complete (GUARANTEED)
                localStorage.clear();
                Object.keys(savedRealData).forEach(key => {
                    localStorage.setItem(key, savedRealData[key]);
                });
                console.log('‚úÖ All tests completed - original localStorage restored');

                // üõ°Ô∏è RESTORE ORIGINAL handlers and clear flag
                window.onbeforeunload = originalBeforeUnload;
                window.setTimeout = originalSetTimeout;
                delete window.__TEST_MODE_NO_RELOAD__;
            }
        });

        // Convert HTML results to plain text format
        function convertResultsToText() {
            const h2 = resultsDiv.querySelector('h2');
            const h3 = resultsDiv.querySelector('h3');

            let text = '='.repeat(80) + '\n';
            text += h2 ? h2.textContent + '\n' : 'Test Results\n';
            text += '='.repeat(80) + '\n\n';

            // Check if this is "Run All Tests" results (has a table)
            const summaryTable = resultsDiv.querySelector('table');

            if (summaryTable) {
                // This is "Run All Tests" format
                if (h3) {
                    text += h3.textContent + '\n\n';
                }

                // Extract table data
                text += 'üìä SUMMARY\n';
                text += '-'.repeat(80) + '\n';
                text += String('Module').padEnd(25) + String('Passed').padStart(10) + String('Total').padStart(10) + String('Status').padStart(15) + '\n';
                text += '-'.repeat(80) + '\n';

                const rows = summaryTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const module = cells[0].textContent.padEnd(25);
                        const passed = cells[1].textContent.padStart(10);
                        const total = cells[2].textContent.padStart(10);
                        const status = cells[3].textContent.padStart(15);
                        text += module + passed + total + status + '\n';
                    }
                });

                // Add footer total
                const footer = summaryTable.querySelector('tfoot tr');
                if (footer) {
                    const cells = footer.querySelectorAll('td');
                    if (cells.length >= 4) {
                        text += '-'.repeat(80) + '\n';
                        const module = cells[0].textContent.padEnd(25);
                        const passed = cells[1].textContent.padStart(10);
                        const total = cells[2].textContent.padStart(10);
                        const status = cells[3].textContent.padStart(15);
                        text += module + passed + total + status + '\n';
                    }
                }
                text += '='.repeat(80) + '\n\n';

                // Add detailed results
                const detailedHeading = Array.from(resultsDiv.querySelectorAll('h3')).find(h => h.textContent.includes('Detailed Results'));
                if (detailedHeading) {
                    text += detailedHeading.textContent + '\n';
                    text += '='.repeat(80) + '\n\n';

                    const moduleBlocks = resultsDiv.querySelectorAll('div[style*="margin: 20px 0"]');
                    moduleBlocks.forEach(block => {
                        const h4 = block.querySelector('h4');
                        if (h4) {
                            text += '\n' + h4.textContent + '\n';
                            text += '-'.repeat(h4.textContent.length) + '\n';
                        }

                        const results = block.querySelectorAll('.result');
                        results.forEach(result => {
                            const isPassing = result.classList.contains('pass');
                            const symbol = isPassing ? '‚úÖ' : '‚ùå';
                            text += symbol + ' ' + result.textContent + '\n';
                        });
                    });
                }

            } else {
                // This is single module format
                const sections = resultsDiv.querySelectorAll('.test-section');
                const results = resultsDiv.querySelectorAll('.result');
                const summary = resultsDiv.querySelector('h3:last-of-type');

                if (h3 && h3.textContent.includes('Running')) {
                    // Skip the "Running tests..." message
                }

                let currentSection = '';
                results.forEach(result => {
                    // Check if there's a section header before this result
                    const prevSibling = result.previousElementSibling;
                    if (prevSibling && prevSibling.classList.contains('test-section')) {
                        currentSection = prevSibling.textContent;
                        text += '\n' + currentSection + '\n';
                        text += '-'.repeat(currentSection.length) + '\n';
                    }

                    // Add the test result
                    const isPassing = result.classList.contains('pass');
                    const symbol = isPassing ? '‚úÖ' : '‚ùå';
                    text += symbol + ' ' + result.textContent + '\n';
                });

                text += '\n' + '='.repeat(80) + '\n';
                if (summary) {
                    text += summary.textContent + '\n';
                }
            }

            text += '='.repeat(80) + '\n';

            return text;
        }
    </script>
    </div> <!-- Close container -->
</body>
</html>
