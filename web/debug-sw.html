<!DOCTYPE html>
<html>
<head>
  <title>Service Worker Debug Tool</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #1177bb;
    }
    .output {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #ce9178; }
  </style>
</head>
<body>
  <h1>🔧 Service Worker Diagnostic Tool</h1>

  <div>
    <button onclick="checkSWStatus()">📊 Check SW Status</button>
    <button onclick="checkCaches()">💾 Check Caches</button>
    <button onclick="forceUpdate()">🔄 Force Update</button>
    <button onclick="unregisterAll()">🗑️ Unregister All</button>
    <button onclick="clearAllCaches()">🧹 Clear All Caches</button>
    <button onclick="fullReset()">⚠️ FULL RESET</button>
  </div>

  <div id="output" class="output">
    Click a button to run diagnostics...
  </div>

  <script>
    const output = document.getElementById('output');

    function log(msg, type = 'info') {
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg + '\n';
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }

    function clear() {
      output.innerHTML = '';
    }

    async function checkSWStatus() {
      clear();
      log('🔍 Checking Service Worker Status...', 'info');

      const registrations = await navigator.serviceWorker.getRegistrations();
      log(`\n📋 Found ${registrations.length} registration(s)\n`, 'info');

      for (const reg of registrations) {
        const active = reg.active;
        const waiting = reg.waiting;
        const installing = reg.installing;

        log('─────────────────────────────', 'info');
        log(`Scope: ${reg.scope}`, 'info');

        if (active) {
          log(`✅ ACTIVE: ${active.scriptURL}`, 'success');
          log(`   State: ${active.state}`, 'info');
        }

        if (waiting) {
          log(`⏳ WAITING: ${waiting.scriptURL}`, 'warning');
          log(`   State: ${waiting.state}`, 'info');
        }

        if (installing) {
          log(`⚙️ INSTALLING: ${installing.scriptURL}`, 'warning');
          log(`   State: ${installing.state}`, 'info');
        }

        if (!active && !waiting && !installing) {
          log('❌ No service worker found', 'error');
        }
      }

      // Check controller
      const controller = navigator.serviceWorker.controller;
      if (controller) {
        log(`\n🎮 Current Controller: ${controller.scriptURL}`, 'success');
      } else {
        log(`\n❌ No controller (page not controlled by SW)`, 'error');
      }
    }

    async function checkCaches() {
      clear();
      log('💾 Checking Caches...', 'info');

      const cacheNames = await caches.keys();
      log(`\n📦 Found ${cacheNames.length} cache(s)\n`, 'info');

      for (const cacheName of cacheNames) {
        log(`\n📂 Cache: ${cacheName}`, 'info');
        const cache = await caches.open(cacheName);
        const keys = await cache.keys();

        log(`   Files: ${keys.length}`, 'info');

        // Check for utilities
        const utilityFiles = keys.filter(req => req.url.includes('utilities/'));
        if (utilityFiles.length > 0) {
          log(`   📁 Utilities:`, 'warning');
          utilityFiles.forEach(req => {
            const url = new URL(req.url);
            log(`      - ${url.pathname}`, 'info');
          });
        }

        // Check for notifications.js specifically
        const notificationsFile = keys.find(req => req.url.includes('notifications.js'));
        if (notificationsFile) {
          log(`   🔔 notifications.js: ${notificationsFile.url}`, 'success');
        }
      }
    }

    async function forceUpdate() {
      clear();
      log('🔄 Forcing Service Worker Update...', 'info');

      const registrations = await navigator.serviceWorker.getRegistrations();

      for (const reg of registrations) {
        try {
          await reg.update();
          log(`✅ Update check triggered for ${reg.scope}`, 'success');
        } catch (err) {
          log(`❌ Update failed: ${err.message}`, 'error');
        }
      }

      log('\n⏳ Waiting 2 seconds for update...', 'info');
      setTimeout(async () => {
        await checkSWStatus();
      }, 2000);
    }

    async function unregisterAll() {
      clear();
      log('🗑️ Unregistering All Service Workers...', 'warning');

      const registrations = await navigator.serviceWorker.getRegistrations();

      for (const reg of registrations) {
        try {
          await reg.unregister();
          log(`✅ Unregistered: ${reg.scope}`, 'success');
        } catch (err) {
          log(`❌ Failed to unregister: ${err.message}`, 'error');
        }
      }

      log('\n✅ All service workers unregistered', 'success');
      log('🔄 Reload the page to register new SW', 'warning');
    }

    async function clearAllCaches() {
      clear();
      log('🧹 Clearing All Caches...', 'warning');

      const cacheNames = await caches.keys();

      for (const cacheName of cacheNames) {
        try {
          await caches.delete(cacheName);
          log(`✅ Deleted cache: ${cacheName}`, 'success');
        } catch (err) {
          log(`❌ Failed to delete ${cacheName}: ${err.message}`, 'error');
        }
      }

      log('\n✅ All caches cleared', 'success');
      log('🔄 Reload the page to rebuild cache', 'warning');
    }

    async function fullReset() {
      if (!confirm('⚠️ This will:\n1. Unregister all service workers\n2. Clear all caches\n3. Reload the page\n\nContinue?')) {
        return;
      }

      clear();
      log('⚠️ FULL RESET INITIATED', 'error');

      // Step 1: Unregister all SWs
      log('\n🗑️ Step 1: Unregistering service workers...', 'info');
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.unregister();
        log(`   ✅ Unregistered: ${reg.scope}`, 'success');
      }

      // Step 2: Clear all caches
      log('\n🧹 Step 2: Clearing caches...', 'info');
      const cacheNames = await caches.keys();
      for (const cacheName of cacheNames) {
        await caches.delete(cacheName);
        log(`   ✅ Deleted: ${cacheName}`, 'success');
      }

      // Step 3: Clear localStorage service worker flag
      log('\n📝 Step 3: Clearing flags...', 'info');
      try {
        sessionStorage.removeItem('sw-migration-reload-done');
        log('   ✅ Cleared session flag', 'success');
      } catch (e) {
        log(`   ⚠️ Could not clear session flag: ${e.message}`, 'warning');
      }

      log('\n✅ RESET COMPLETE', 'success');
      log('🔄 Reloading in 2 seconds...', 'warning');

      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }

    // Auto-run status check on load
    window.addEventListener('load', () => {
      setTimeout(checkSWStatus, 100);
    });
  </script>
</body>
</html>
